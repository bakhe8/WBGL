name: Change Gate (WBGL)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  gate:
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    env:
      WBGL_DB_DRIVER: pgsql
      WBGL_DB_HOST: 127.0.0.1
      WBGL_DB_PORT: 5432
      WBGL_DB_NAME: wbgl
      WBGL_DB_USER: wbgl_user
      WBGL_DB_PASS: ${{ secrets.WBGL_CI_DB_PASSWORD }}
      WBGL_DB_SSLMODE: disable
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: wbgl_user
          POSTGRES_PASSWORD: ${{ secrets.WBGL_CI_DB_PASSWORD }}
          POSTGRES_DB: wbgl
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U wbgl_user -d wbgl"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Assert CI DB secret
        run: |
          set -euo pipefail
          if [ -z "${WBGL_DB_PASS}" ]; then
            echo "WBGL_CI_DB_PASSWORD secret is required."
            exit 1
          fi

      - name: Read PR body
        id: pr
        run: |
          body="$(jq -r '.pull_request.body // ""' "$GITHUB_EVENT_PATH")"
          {
            echo "body<<EOF"
            echo "$body"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Validate required PR fields
        env:
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          set -euo pipefail
          missing=0
          required=("PLAN-REF:" "GAP-REF:" "LAYER:" "RISK:" "ROLLBACK:" "TEST-EVIDENCE:" "IMPACTED FEATURES:" "DOC-UPDATES:" "REUSE-REF:")
          for key in "${required[@]}"; do
            if ! grep -qi "$key" <<<"$PR_BODY"; then
              echo "Missing required field: $key"
              missing=1
            fi
          done

          if ! grep -Eqi 'PLAN-REF:.*WBGL_MASTER_UPGRADE_PLAN' <<<"$PR_BODY"; then
            echo "PLAN-REF must reference WBGL_MASTER_UPGRADE_PLAN."
            missing=1
          fi

          if ! grep -Eqi 'GAP-REF:.*(FINAL_MISSING_FEATURES_MATRIX|final_missing_features_matrix|WBGL_BG_Full_Feature_Census|differential_analysis)' <<<"$PR_BODY"; then
            echo "GAP-REF must reference the comparison corpus (matrix/census/differential)."
            missing=1
          fi

          valid_layers='(Architectural|Structural|Logical|Operational|Security|Governance|UX|Data)'
          if ! grep -Eqi "LAYER:.*$valid_layers" <<<"$PR_BODY"; then
            echo "LAYER must include one or more valid values: Architectural/Structural/Logical/Operational/Security/Governance/UX/Data."
            missing=1
          fi

          if ! grep -Eqi 'REUSE-REF:.*(app/|api/|maint/|docs/)' <<<"$PR_BODY"; then
            echo "REUSE-REF must mention existing WBGL paths used as implementation seeds."
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Collect changed files
        id: changes
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}:${{ github.base_ref }}"
          files="$(git diff --name-only "${{ github.base_ref }}...HEAD")"
          statuses="$(git diff --name-status "${{ github.base_ref }}...HEAD")"
          printf "%s\n" "$files"
          {
            echo "files<<EOF"
            echo "$files"
            echo "EOF"
            echo "statuses<<EOF"
            echo "$statuses"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Require execution loop status refresh for sensitive changes
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
        run: |
          set -euo pipefail
          sensitive='^(api/|app/|partials/|templates/|views/|public/js/|public/css/|maint/|database/migrations/)'
          if grep -Eq "$sensitive" <<<"$CHANGED_FILES"; then
            if ! grep -Eq '^docs/WBGL_EXECUTION_LOOP_STATUS\.json$' <<<"$CHANGED_FILES"; then
              echo "Sensitive code changed but docs/WBGL_EXECUTION_LOOP_STATUS.json was not refreshed."
              echo "Run: php maint/run-execution-loop.php and commit the generated status artifact."
              exit 1
            fi
          fi

      - name: Enforce execution loop readiness baseline
        run: |
          set -euo pipefail
          status_file="docs/WBGL_EXECUTION_LOOP_STATUS.json"
          if [ ! -f "$status_file" ]; then
            echo "Missing $status_file."
            echo "Run: php maint/run-execution-loop.php and commit docs/WBGL_EXECUTION_LOOP_STATUS.json."
            exit 1
          fi

          jq -e '.next_batch | length == 0' "$status_file" >/dev/null || {
            echo "Execution loop is not fully closed: next_batch is not empty."
            exit 1
          }

          jq -e '.api_guard.guarded == .api_guard.total and .api_guard.sensitive_unguarded == 0' "$status_file" >/dev/null || {
            echo "API guard baseline is not satisfied (guarded/unguarded mismatch)."
            exit 1
          }

          jq -e '.migrations.pending == 0' "$status_file" >/dev/null || {
            echo "Pending migrations detected in execution loop status."
            exit 1
          }

          jq -e '.scheduler.run_ledger_table_present and .scheduler.dead_letter_table_present and .scheduler.runtime_dead_letter_integration' "$status_file" >/dev/null || {
            echo "Scheduler readiness baseline failed (runtime/dead-letter not fully ready)."
            exit 1
          }

          jq -e '.observability.metrics_api_present and .observability.metrics_service_present and .observability.metrics_api_permission_guarded and .observability.metrics_api_policy_mapped and .observability.api_request_id_wired' "$status_file" >/dev/null || {
            echo "Observability baseline failed (metrics/request-id wiring)."
            exit 1
          }

          jq -e '.db_cutover.ready == true and .db_cutover.driver_status_command_present and .db_cutover.cutover_check_command_present and .db_cutover.backup_command_present and .db_cutover.portability_check_command_present and .db_cutover.fingerprint_command_present and .db_cutover.pg_activation_rehearsal_command_present and .db_cutover.cutover_runbook_present and .db_cutover.backup_restore_runbook_present and .db_cutover.pg_activation_runbook_present and .db_cutover.schema_migrations_table_present and .db_cutover.migration_tooling_driver_aware' "$status_file" >/dev/null || {
            echo "DB cutover baseline failed (scripts/runbooks/migration tooling/backup readiness)."
            exit 1
          }

          jq -e '.ci_cd.enterprise_workflows_ready == true and .ci_cd.change_gate_workflow_present and .ci_cd.ci_workflow_present and .ci_cd.security_workflow_present and .ci_cd.release_workflow_present' "$status_file" >/dev/null || {
            echo "Enterprise CI/CD workflows baseline failed (change-gate/ci/security/release)."
            exit 1
          }

          jq -e '.sod_compliance.ready == true and .sod_compliance.governance_policy_doc_present and .sod_compliance.sod_matrix_doc_present and .sod_compliance.break_glass_runbook_present and .sod_compliance.self_approval_guard_enforced and .sod_compliance.break_glass_permission_gate_enforced and .sod_compliance.break_glass_ticket_policy_present and .sod_compliance.audit_tables_present' "$status_file" >/dev/null || {
            echo "SoD/compliance baseline failed (docs + enforcement + audit tables)."
            exit 1
          }

          jq -e '.history_hybrid.columns_present and .history_hybrid.service_present and .history_hybrid.snapshot_reader_integration_present' "$status_file" >/dev/null || {
            echo "History hybrid readiness baseline failed."
            exit 1
          }

          jq -e '.print_governance.table_present and .print_governance.api_endpoint_present and .print_governance.single_letter_wiring and .print_governance.batch_wiring' "$status_file" >/dev/null || {
            echo "Print governance readiness baseline failed."
            exit 1
          }

          jq -e '.config_governance.table_present and .config_governance.save_hook_wired' "$status_file" >/dev/null || {
            echo "Config governance readiness baseline failed."
            exit 1
          }

          jq -e '.security_baseline.session_security_service_present and .security_baseline.security_headers_service_present and .security_baseline.csrf_guard_service_present and .security_baseline.autoload_session_hardening_wired and .security_baseline.autoload_security_headers_wired and .security_baseline.autoload_non_api_csrf_guard_wired and .security_baseline.api_bootstrap_csrf_guard_wired and .security_baseline.login_endpoint_csrf_guard_wired and .security_baseline.frontend_security_runtime_present and .security_baseline.frontend_security_runtime_wired and .security_baseline.logout_hard_destroy_wired and .security_baseline.rate_limit_user_agent_fingerprint_wired' "$status_file" >/dev/null || {
            echo "Security baseline readiness failed (session/headers/csrf/rate-limit)."
            exit 1
          }

          jq -e '.reopen_governance.batch_audit_table_present and .reopen_governance.break_glass_table_present and .reopen_governance.batch_permission_gate_wired and .reopen_governance.batch_reason_enforced and .reopen_governance.guarantee_permission_gate_wired and .reopen_governance.break_glass_auth_wired' "$status_file" >/dev/null || {
            echo "Reopen governance/break-glass readiness baseline failed."
            exit 1
          }

          jq -e '.released_read_only.policy_service_present and .released_read_only.extend_guarded and .released_read_only.reduce_guarded and .released_read_only.update_guarded and .released_read_only.save_and_next_guarded and .released_read_only.attachment_guarded' "$status_file" >/dev/null || {
            echo "Released read-only policy readiness baseline failed."
            exit 1
          }

          jq -e '.ux_a11y.a11y_css_present and .ux_a11y.index_linked and .ux_a11y.batch_detail_linked and .ux_a11y.settings_linked' "$status_file" >/dev/null || {
            echo "UX/A11y readiness baseline failed."
            exit 1
          }

          jq -e '.ui_architecture.readiness.translation_target_pass and .ui_architecture.readiness.rtl_target_pass and .ui_architecture.readiness.theme_token_target_pass and .ui_architecture.readiness.view_guard_target_pass and .ui_architecture.readiness.api_matrix_parity_pass' "$status_file" >/dev/null || {
            echo "UI architecture readiness baseline failed (i18n/rtl/theme/view-guard/api-matrix)."
            exit 1
          }

          jq -e '.playwright.ready == true and .playwright.tests_count > 0' "$status_file" >/dev/null || {
            echo "Playwright readiness baseline failed."
            exit 1
          }

          jq -e '.tests.integration_files > 0 and .tests.integration_flow_suite_present == true' "$status_file" >/dev/null || {
            echo "Integration test baseline failed (missing integration suite coverage)."
            exit 1
          }

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pgsql, pdo_pgsql, fileinfo
          coverage: none

      - name: Install PHP dependencies
        run: composer install --no-interaction --no-progress --prefer-dist

      - name: Apply DB migrations
        run: php maint/migrate.php

      - name: Run PHPUnit Unit suite
        run: vendor/bin/phpunit --testsuite Unit

      - name: Run PHPUnit Integration suite
        run: vendor/bin/phpunit --testsuite Integration

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install E2E dependencies
        run: |
          set -euo pipefail
          npm ci
          npx playwright install chromium

      - name: Run Playwright smoke suite
        run: npm run test:e2e

      - name: Enforce API auth bootstrap on changed endpoints
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
        run: |
          set -euo pipefail

          api_files="$(grep -E '^api/.*\.php$' <<<"$CHANGED_FILES" || true)"
          if [ -z "$api_files" ]; then
            echo "No API endpoint changes detected."
            exit 0
          fi

          fail=0
          while IFS= read -r f; do
            [ -z "$f" ] && continue

            case "$f" in
              api/login.php|api/logout.php|api/_bootstrap.php)
                # Public/auth bootstrap files are intentionally excluded.
                continue
                ;;
            esac

            if ! grep -Eq '_bootstrap\.php' "$f"; then
              echo "API guard failed: $f must include api/_bootstrap.php."
              fail=1
              continue
            fi

            if ! grep -Eq 'wbgl_api_require_login|wbgl_api_require_permission' "$f"; then
              echo "API guard failed: $f must call wbgl_api_require_login() or wbgl_api_require_permission()."
              fail=1
            fi
          done <<< "$api_files"

          if [ "$fail" -ne 0 ]; then
            exit 1
          fi

      - name: Require docs updates for sensitive changes
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
        run: |
          set -euo pipefail
          sensitive='^(api/|app/|partials/|templates/|views/|public/js/|public/css/|maint/)'
          if grep -Eq "$sensitive" <<<"$CHANGED_FILES"; then
            if ! grep -Eq '^docs/' <<<"$CHANGED_FILES"; then
              echo "Sensitive code changed, but no docs/ updates detected."
              echo "Please update docs/ with behavior/contract/risk changes."
              exit 1
            fi
          fi

      - name: Require justification for new sensitive files
        env:
          CHANGED_STATUSES: ${{ steps.changes.outputs.statuses }}
          PR_BODY: ${{ steps.pr.outputs.body }}
        run: |
          set -euo pipefail

          added_sensitive="$(awk '$1 ~ /^A/ {print $2}' <<<"$CHANGED_STATUSES" | grep -E '^(api/|app/|maint/|views/|partials/|templates/|public/js/|public/css/)' || true)"
          if [ -z "$added_sensitive" ]; then
            echo "No newly added sensitive files."
            exit 0
          fi

          echo "New sensitive files detected:"
          printf "%s\n" "$added_sensitive"

          if ! grep -Eqi 'NEW-SURFACE-JUSTIFICATION:' <<<"$PR_BODY"; then
            echo "Missing NEW-SURFACE-JUSTIFICATION in PR body for new sensitive files."
            exit 1
          fi
