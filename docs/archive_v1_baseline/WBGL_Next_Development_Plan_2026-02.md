# WBGL — Next Development Plan (2026-02)

**الغرض:** معالجة التناقضات التشغيلية الحرجة في مسار الضمانات وتوحيد منطق العمل بين الكود والوثائق والسلوك المتوقع.

---

## 1) نطاق الخطة

هذه الخطة مخصصة لمعالجة 3 نقاط حرجة تم رصدها كمصدر تعارض منطقي قد يسبب التباسًا تشغيليًا أو سلوكًا غير متسق:

1. سلوك التكرار بين قنوات الإدخال (Excel / Smart Paste / Manual).
2. قاعدة البنك غير المعروف (Reject vs Pending).
3. اتساق تسجيل الأحداث في Timeline مع قواعد الرفض (Reject & Ignore).

---

## 2) المشكلة الأولى: تكرار الإدخال عبر القنوات

### الوضع الحالي
- Excel وSmart Paste يسجلان `Duplicate Import Event` عند التكرار.
- الإدخال اليدوي يرفض التكرار قبل الإنشاء ولا يسجل حدث Duplicate Import.

### الإشكالية
- اختلاف سلوك التكرار حسب القناة يسبب اختلافًا في التتبع التاريخي لنفس الحالة الوظيفية.

### قرار التطوير المطلوب
اختيار سياسة موحدة واحدة من الخيارين:

- **الخيار A (توحيد نحو التسجيل):**
  - عند التكرار اليدوي، لا ينشأ سجل جديد، لكن يسجل `Duplicate Import Event` أيضًا.
- **الخيار B (توحيد نحو الرفض الصامت):**
  - إلغاء تسجيل Duplicate Import في كل القنوات والاكتفاء بالرفض/التخطي.

### معيار القبول
- نفس حالة التكرار تنتج نفس الأثر الوظيفي ونفس الأثر التاريخي بغض النظر عن قناة الإدخال.

---

## 3) المشكلة الثانية: البنك غير المعروف

### الوضع الحالي
- السلوك الفعلي في الكود يسمح بإنشاء الضمان وقد يبقى بدون مطابقة بنك (pending).
- بعض الصياغات التشغيلية السابقة كانت تفترض رفضًا مباشرًا للإدخال عند البنك غير المعروف.

### الإشكالية
- تعارض بين التوقع التشغيلي (Reject) والسلوك الفعلي (Pending) يسبب قرارات تشغيل غير متوقعة.

### قرار التطوير المطلوب
اختيار سياسة صريحة موحدة:

- **الخيار A (Strict Reject):**
  - منع إنشاء الضمان عندما لا يوجد بنك مطابق.
- **الخيار B (Allow Pending):**
  - السماح بإنشاء الضمان مع حالة pending حتى استكمال المطابقة.

### معيار القبول
- وجود قاعدة واحدة موثقة ومطبقة برمجيًا ومعلنة في جميع الوثائق والواجهات.

---

## 4) المشكلة الثالثة: Timeline مقابل Reject & Ignore

### الوضع الحالي
- يوجد تعارض سابق بين عبارات "كل القنوات تسجل أحداثها" وبين حالات يتم فيها رفض الإدخال دون تسجيل حدث.

### الإشكالية
- غموض الحدود بين "حدث تشغيلي" و"طلب مرفوض قبل الإنشاء" يؤثر على التدقيق والتفسير.

### قرار التطوير المطلوب
تعريف رسمي ملزم لطبقتين:

1. **Domain Events:** أحداث مرتبطة بكيان ضمان موجود (تسجل في Timeline).
2. **Rejected Requests Log (اختياري):** سجل منفصل لمحاولات الرفض قبل إنشاء الكيان.

### معيار القبول
- لا يوجد حدث Timeline بدون كيان ضمان.
- حالات الرفض قبل الإنشاء إما موثقة في سجل رفض مستقل أو موثقة رسميًا بأنها خارج Timeline.

---

## 5) خطة التنفيذ المقترحة

### المرحلة 1: قرار السياسات (Design Decision)
- تثبيت قرارات A/B لكل نقطة من النقاط الثلاث.
- اعتماد القرار من مالك المنتج/التشغيل.

### المرحلة 2: تنفيذ الكود
- تعديل APIs والخدمات ذات الصلة (إدخال يدوي، المطابقة البنكية، تسجيل الأحداث).
- توحيد مسار Timeline وفق التعريف النهائي.

### المرحلة 3: تحديث الوثائق
- تحديث:
  - `WBGL_Project_Report_2026-02-13.md`
  - `WBGL_Project_Report_2026-02-13_V2.md`
  - `WBGL_Project_Report_2026-02-13_Audit-Legal.md`
  - `WBGL_Project_Report_2026-02-13_AsIs-Technical.md`
  - `WBGL_Project_Report_2026-02-13_Definitions.md`

### المرحلة 4: اختبار القبول
- حالات اختبار تغطي القنوات الثلاث لنفس السيناريو.
- التحقق من اتساق حالة الضمان + Timeline + رسائل API.

---

## 6) مخاطر عدم المعالجة

- تضارب التفسير بين الفرق (تشغيل/تقنية/تدقيق).
- قرارات تشغيلية غير متسقة لنفس الحالة.
- صعوبة في التحقيق اللاحق بسبب اختلاف الأثر التاريخي حسب قناة الإدخال.

---

## 7) مخرجات الخطة

- سياسة تشغيل موحدة مكتوبة ومعتمدة.
- سلوك برمجي متسق عبر القنوات.
- وثائق متطابقة مع التنفيذ الفعلي.
- قابلية تدقيق أعلى وانخفاض احتمال الالتباس التشغيلي.
