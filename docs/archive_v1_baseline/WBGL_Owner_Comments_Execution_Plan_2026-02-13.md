# خطة تنفيذية مباشرة بناءً على تعليقات المالك

التاريخ: 2026-02-13  
المرجع: تعليقات المالك على أول 4 نقاط في التقرير العربي التشغيلي  
هدف الخطة: تنفيذ إصلاحات دقيقة بدون كسر منطق التشغيل اليومي الحالي

---

## المهمة 1: توحيد مرجعية التنقل مع الحفاظ على فائدة الفلترة

### تعليق المالك (مترجم إلى شرط تنفيذ)
الحل مطلوب بشرط عدم كسر فائدة التنقل التالي/السابق داخل الفلتر أو خارجه.

### المطلوب تنفيذه
- توحيد مصدر تحديد السجل الحالي بين الفورم و Timeline عبر مرجع واحد.
- جعل التالي/السابق يعتمد نفس منطق الفلترة النشطة.
- عند عدم وجود فلتر، يعمل التنقل على كامل السجلات.

### شرط عدم الكسر
- لا يتم إلغاء الفلترة.
- لا يتم تغيير تجربة التالي/السابق الحالية إلا لرفع الاتساق.

### معيار القبول
- نفس رقم الضمان يظهر متطابقًا في: الفورم، الـTimeline، ونتيجة الحفظ والانتقال.
- عند فلتر pending أو ready يظل التنقل داخل نفس المجموعة فقط.

### اختبار تحقق سريع
1. افتح مع فلتر pending.
2. تنقل 5 مرات عبر التالي.
3. في كل مرة تحقق أن رقم الضمان في الفورم = رقم الضمان في Timeline.
4. أزل الفلتر وكرر الاختبار.

---

## المهمة 2: إصلاح تشغيل الاختبارات بدون تكرار أو إعادة اختراع

### تعليق المالك (مترجم إلى شرط تنفيذ)
إصلاح مطلوب بدون تكرار ما هو موجود في ملف phpunit.xml.

### المطلوب تنفيذه
- إصلاح قابلية تشغيل PHPUnit بناء على البنية الحالية فقط.
- عدم إنشاء هيكل اختبارات بديل أو ملف إعداد جديد متضارب.
- التأكد أن التشغيل يستخدم نفس تعريفات phpunit.xml الحالية.

### شرط عدم الكسر
- لا تعديل مفاهيمي على استراتيجية الاختبار الحالية.
- لا ازدواجية بين إعدادين مختلفين للاختبار.

### معيار القبول
- أمر php vendor/bin/phpunit يعمل فعليًا بدون خطأ include للمسار المفقود.
- يتم تحميل إعدادات phpunit.xml الحالية كما هي.

### اختبار تحقق سريع
1. تشغيل php vendor/bin/phpunit --version.
2. تشغيل php vendor/bin/phpunit.
3. تأكيد أن الخطأ السابق الخاص بمسار phpunit لم يعد يظهر.

---

## المهمة 3: إزالة الاعتماد على global db مع الحفاظ على نفس منطق الحالة

### تعليق المالك (مترجم إلى شرط تنفيذ)
الإصلاح مطلوب بشرط عدم التناقض مع المنطق الحالي الظاهر في الشاشة.

### المطلوب تنفيذه
- تعديل دالة تقييم الحالة لتستقبل اتصال قاعدة البيانات بشكل صريح أو تستخدم مصدر اتصال ثابت داخليًا.
- منع الاعتماد على global db في مسار حساب الحالة.

### شرط عدم الكسر
- لا تغيير لقواعد الحالة الحالية:
  - ready عندما يوجد supplier_id و bank_id.
  - pending خلاف ذلك.
- لا تغيير في النصوص أو سلوك العرض للمستخدم.

### معيار القبول
- نتائج الحالة قبل/بعد الإصلاح متطابقة لنفس السجلات.
- لا تظهر فروقات بين الشاشة والخدمات الأخرى عند تقييم نفس السجل.

### اختبار تحقق سريع
1. اختر سجلًا ready وسجلًا pending.
2. قارن ناتج الحالة قبل وبعد الإصلاح.
3. تأكد من ثبات أزرار الإجراءات المرتبطة بالحالة في الشاشة.

---

## المهمة 4: تحويل استعلامات التحقق إلى Prepared Statements بدون تغيير السلوك

### تعليق المالك (مترجم إلى شرط تنفيذ)
الإصلاح مطلوب بشرط عدم إحداث مشكلة في سلوك التحقق الحالي.

### المطلوب تنفيذه
- استبدال استعلامات التحقق المكتوبة بصيغة interpolation في نقاط التعديل.
- استخدام Prepared Statements مكافئة منطقيًا لنفس شرط التحقق.

### شرط عدم الكسر
- نفس نتائج التحقق الحالية يجب أن تستمر:
  - النجاح عند وجود السجل الصحيح.
  - الفشل عند عدم الوجود.
- نفس الرسائل التشغيلية دون تغيير جوهري.

### معيار القبول
- سيناريو تعديل بنك ومورد يمر بنفس النتيجة المتوقعة قبل/بعد.
- لا تناقض بين نتيجة التنفيذ ونتيجة خطوة التحقق.

### اختبار تحقق سريع
1. نفذ تحديث بنك صالح وتأكد من success.
2. نفذ تحديث مورد صالح وتأكد من success.
3. اختبر معرف غير موجود وتأكد من خطأ متوقع بدون سلوك متذبذب.

---

## ترتيب التنفيذ المقترح
1. المهمة 1 (الأعلى أثرًا على القرار اليومي).
2. المهمة 3 (منع تضارب منطق الحالة).
3. المهمة 4 (تحسين الاتساق دون تغيير سلوك).
4. المهمة 2 (استعادة أمان التعديل المستقبلي).

---

## تعريف الانتهاء (Definition of Done)
- لكل مهمة: تطبيق + تحقق سريع + توثيق نتيجة مختصرة.
- لا يوجد تغيير مرئي غير مقصود في تجربة المستخدم اليومية.
- أي اختلاف عن السلوك الحالي يوثق قبل الاعتماد النهائي.