# WBGL — التقرير التشغيلي الشامل (V2)

**الإصدار:** V2  
**التاريخ:** 2026-02-13  
**المرجع:** نسخة منقحة ومنظمة من التقرير الأساسي مع الحفاظ على نفس حقائق النظام الحالية.

---

## 1) الملخص التنفيذي

- WBGL نظام تشغيلي لإدارة الضمانات البنكية مع سجل تاريخي دقيق لكل حدث (Timeline).
- الإدخال يتم عبر 3 مسارات رئيسية: Excel، إدخال يدوي، لصق ذكي.
- مطابقة البنك آلية (غير متعلمة)، بينما مطابقة المورد ذكية (متعلمة) مع درجات ثقة واقتراحات.
- جميع الأحداث التشغيلية تُسجل مع Snapshot قبل الحدث، بما فيها محاولات الاستيراد المكرر.
- الإجراءات التشغيلية الحالية: تمديد، تخفيض، إفراج؛ والإفراج فقط يغير الحالة إلى مفرج عنه ثم يقفل الضمان.
- المخرج الرسمي للنظام: خطابات معيارية ثابتة لكل إجراء عبر قالب موحد.

---

## 2) الهوية والاستقلال

- المشروع يعمل بهوية مستقلة باسم **WBGL**.
- الربط المعتمد للمستودع: `git@github.com:bakhe8/WBGL.git`.
- الفرع التشغيلي المعتمد: `main`.
- تم توحيد الهوية النصية في الملفات الأساسية لتتوافق مع WBGL.

---

## 3) التشغيل المحلي (Windows)

### 3.1 الهدف
تشغيل محلي مستقل بدون تضارب منافذ أو تعارض مع مشاريع أخرى.

### 3.2 مكونات التشغيل
- سكربت إدارة موحد: `wbgl_server.ps1`.
- مشغل سريع: `toggle.bat`.
- تشغيل صامت للاختصار: `WBGL_8181.vbs` (داخل جذر المشروع).

### 3.3 السلوك المعتمد
- أوامر الإدارة: `start | stop | restart | toggle`.
- دعم منفذ ثابت (مثل 8181).
- آلية واضحة لإيقاف/إعادة التشغيل لتفادي تضارب المنافذ.

---

## 4) نموذج التشغيل العام

### 4.1 دورة العمل
إدخال/استخراج → مطابقة بنك → مطابقة مورد → مراجعة/جاهز → إجراء (تمديد/تخفيض/إفراج) → خطاب.

### 4.2 Timeline كمرجع حوكمة
- كل حدث يُسجل في Timeline.
- كل حدث يحتفظ Snapshot للحالة السابقة.
- الضغط على الحدث يعيد عرض الحالة السابقة للحدث في الواجهة.

---

## 5) طرق الإدخال والاستيراد والفروقات

### 5.1 مقارنة سريعة

| الطريقة | نقطة الدخول | البيانات | سلوك التكرار | شكل الدفعة | أفضل استخدام |
|---|---|---|---|---|---|
| Excel | `api/import.php` | صفوف ملف `.xlsx/.xls` | لا ينشئ سجل جديد عند التكرار؛ يسجل تكرار + ظهور | `excel_*` / `test_excel_*` | تحميل جماعي |
| يدوي | `api/create-guarantee.php` | حقول مباشرة | يرفض إذا رقم الضمان موجود | `manual_paste_YYYYMMDD` | حالة واحدة دقيقة |
| لصق ذكي | `api/parse-paste.php` | نص حر | يرجع للسجل الموجود ويسجل تكرار | `manual_paste_YYYYMMDD` | إدخال سريع من نصوص غير منظمة |

### 5.2 ماذا يحدث داخليًا في كل مسار

**أ) Excel**
- التحقق من الملف ونقله مؤقتًا.
- كشف ذكي لرأس الأعمدة.
- معالجة كل صف صالح (إنشاء جديد أو معالجة كتكرار).
- تسجيل أحداث الاستيراد في Timeline.
- تشغيل المطابقة الذكية بعد الاستيراد للسجلات الجديدة.

**ب) الإدخال اليدوي**
- التحقق من الحقول الإلزامية.
- التحقق من عدم تكرار رقم الضمان.
- إنشاء السجل وربطه بدفعة اليوم.
- تسجيل حدث الاستيراد + تشغيل المطابقة الذكية.

**ج) اللصق الذكي**
- تحليل النص واستخراج الحقول.
- إنشاء سجل جديد أو اعتبار الحالة مكررة إذا السجل موجود.
- تسجيل الاستيراد/التكرار في Timeline.
- تشغيل المطابقة الذكية للسجلات الجديدة.

### 5.3 قاعدة الاستيراد المكرر (مهم)
- يمكن محاولة استيراد نفس الضمان أكثر من مرة عبر مسارات الإدخال.
- يتم تسجيل حدث **استيراد مكرر** في Timeline عند التكرار عبر **Excel** و**Smart Paste**.
- في الإدخال اليدوي، تكرار رقم الضمان يُرفض قبل الإنشاء.
- لا يتم تغيير تاريخ الضمان التشغيلي ولا العبث بمسار حالته بسبب هذه المحاولة.

---

## 6) نظام المطابقة: البنك مقابل المورد

### 6.1 مطابقة البنك
- آلية فقط (غير متعلمة).
- تعتمد على البنوك المعرفة مسبقًا في النظام.
- إذا لم يوجد تطابق بنكي: قد يُنشأ الضمان وتبقى المطابقة البنكية غير مكتملة (pending) حتى تحديث البيانات المرجعية أو المعالجة اللاحقة.

### 6.2 مطابقة المورد
- ذكية متعلمة من قرارات المستخدم السابقة.
- تعرض اقتراحات مع درجات ثقة.
- تدعم أثناء المطابقة: اعتماد، تعديل، إضافة مورد جديد.
- قرارات المستخدم تُستخدم لتحسين الدقة مستقبلًا.

---

## 7) الإجراءات التشغيلية والحالة

### 7.1 الإجراءات الحالية
- تمديد
- تخفيض
- إفراج

### 7.2 تأثير كل إجراء على الحالة
- التمديد/التخفيض: إجراءات تشغيلية لا تُحوّل الحالة إلى مفرج عنه.
- الإفراج: الإجراء الوحيد الذي يحول الحالة من **جاهز** إلى **مفرج عنه**.
- بعد الإفراج يصبح الضمان **Locked**.

### 7.3 إجراءات مستقبلية مستهدفة
- التحقق من صحة الضمان.
- طلب إصدار بدل فاقد.

---

## 8) نظام الدفعات (Batches)

- إدارة تشغيل جماعي للسجلات.
- تغطية دورة الدفعة: إنشاء، متابعة، تفاصيل، طباعة.
- تمثل طبقة تنظيم تشغيلية فوق السجل الفردي.
- تظهر بوضوح في صفحات الدفعات والتقارير.

---

## 9) الملاحظات والمرفقات لكل ضمان

- يمكن إضافة ملاحظة لأي ضمان.
- يمكن إرفاق مستندات/ملفات لكل ضمان.
- تُستخدم كمرجعية داعمة للمراجعة، التدقيق، واتخاذ القرار.
- تُسجل ضمن التاريخ التشغيلي للأحداث.

---

## 10) التعلم الآلي (تبويب الإعدادات)

### 10.1 ما يعرضه التبويب
- عدد الأنماط المؤكدة (Confirmations).
- عدد حالات الرفض/العقاب (Rejections).

### 10.2 أنواع التعلم
- تعلم إيجابي: من الأنماط المؤكدة.
- تعلم سلبي: من الأنماط المرفوضة مع خصم ثقة.

### 10.3 إدارة ذاكرة التعلم
- نسيان نمط متعلم (حذف).
- إلغاء عقوبة نمط مرفوض.

### 10.4 إعدادات مؤثرة
- `REJECTION_PENALTY_PERCENTAGE`
- `CONFIRMATION_BOOST_TIER1/2/3`
- أوزان `BASE_SCORE_*`

> هذه المنظومة مرتبطة بمطابقة المورد، وليست مطابقة البنك.

---

## 11) Production Mode وتأثيره على قاعدة البيانات

### 11.1 الفكرة
عند تفعيل `PRODUCTION_MODE` يتحول النظام لنمط إنتاجي يحمي التشغيل الحقيقي من بيانات الاختبار.

### 11.2 على مستوى الكتابة (Write)
- يمنع إنشاء بيانات اختبار (`is_test_data=1`) في:
  - `api/create-guarantee.php`
  - `api/import.php`
  - `api/parse-paste.php`
- عند المخالفة يعيد `403`.

### 11.3 على مستوى القراءة (Read)
- لا يحذف بيانات الاختبار فعليًا من قاعدة البيانات.
- يفلترها من النتائج بشرط:
  - `(is_test_data = 0 OR is_test_data IS NULL)`
- ينعكس ذلك على الإحصائيات، التصفح، الدفعات، والطباعة.

### 11.4 على مستوى الصيانة والسجلات
- أدوات صيانة/حذف بيانات الاختبار تكون معطلة أو مخفية في وضع الإنتاج.
- إيقاف `DEBUG` logs، مع استمرار `INFO/WARNING/ERROR`.

### 11.5 الخلاصة
`Production Mode` = منع اختبار جديد + فلترة اختبار موجود من التشغيل، وليس حذفًا تلقائيًا للبيانات.

---

## 12) الإعدادات: الحفظ والفائدة

### 12.1 مسار الحفظ
- واجهة الإعدادات: `views/settings.php`
- API الإعدادات: `api/settings.php`
- التخزين الدائم: `storage/settings.json`
- المرجع المركزي للقيم الافتراضية: `app/Support/Settings.php`

### 12.2 طريقة العمل
- الواجهة ترسل JSON إلى API.
- API يطبق تحققًا منطقيًا وحدود القيم.
- عند النجاح تحفظ القيم وتُعاد تحميل الواجهة لتطبيقها.

### 12.3 ما يُحفظ كإعدادات وما يُحفظ كبيانات
- Settings العامة (عتبات/أوزان/تعلم/توقيت/Production): في JSON.
- بيانات البنوك والموردين وأنماط التعلم: في قاعدة البيانات.
- ملفات JSON الخاصة بالاستيراد/التصدير للبنوك والموردين: وسيط تبادل، وليست مصدر الحقيقة النهائي.

---

## 13) إدارة البنوك والموردين من صفحة الإعدادات

### 13.1 تبويب البنوك
- عرض: `api/get_banks.php`
- إضافة: `api/create-bank.php`
- تعديل: `api/update_bank.php`
- حذف: `api/delete_bank.php`
- تصدير: `api/export_banks.php`
- استيراد: `api/import_banks.php`

### 13.2 تبويب الموردين
- عرض: `api/get_suppliers.php`
- إضافة: `api/create-supplier.php`
- تعديل: `api/update_supplier.php`
- حذف: `api/delete_supplier.php`
- تصدير: `api/export_suppliers.php`
- استيراد: `api/import_suppliers.php`

### 13.3 الأثر التشغيلي
- تمكين الفريق من صيانة Master Data بدون تدخل برمجي.
- معالجة أسرع لحالات البنك غير المعروف.
- تحسين مستمر لجودة مطابقة المورد.

---

## 14) صفحة الإحصائيات المتقدمة

**المسار:** `views/statistics.php`

### 14.1 ماذا تقيس
- المؤشرات العامة (Assets/Occurrences/Amounts).
- تحليل الدفعات.
- تحليلات البنوك والموردين.
- الأداء الزمني.
- الانتهاء والإجراءات.
- الذكاء الاصطناعي والتعلم.
- التحليل المالي ومؤشرات ROI.

### 14.2 مصادر البيانات
تعتمد على جداول مثل:
- `guarantees`
- `guarantee_occurrences`
- `guarantee_decisions`
- `guarantee_history`
- `batch_metadata`
- `banks` / `suppliers`
- `learning_confirmations` و`learning_patterns` (عند توفرها)

### 14.3 التكامل مع Production Mode
- المؤشرات تُفلتر تلقائيًا من بيانات الاختبار في وضع الإنتاج.
- الصفحة تعمل بسياسة `no-cache` لتقليل عرض بيانات قديمة.

---

## 15) نموذج الخطابات الثابت (المخرج الرسمي)

- المخرج الرسمي للنظام هو **خطاب بنكي معياري** لكل إجراء.
- الإجراءات المعتمدة للخطابات: تمديد، تخفيض، إفراج.
- البنية ثابتة، والمحتوى يتغير حسب الإجراء والبيانات.

### 15.1 المصدر الموحد للبناء
- خدمة البناء: `app/Services/LetterBuilder.php`
- القالب الموحد: `templates/letter-template.php`
- المعاينة/التقديم: `api/get-letter-preview.php` + مسارات الطباعة.

### 15.2 النتيجة
- اتساق كامل في المخرجات.
- تقليل التباين بين الخطابات الفردية والمجمعة.
- سهولة التدقيق والاعتماد.

---

## 16) تقييم النضج التشغيلي

- نضج الفلو التشغيلي: **8/10**
- نضج الحوكمة والتتبع: **8.5/10**
- الجاهزية للإنتاج التشغيلي: **8/10**

---

## 17) توصيات تنفيذية مختصرة

1. تعزيز عرض Timeline بصريًا (قبل/إجراء/بعد).
2. توحيد مصطلحات الحالة والإجراءات في الواجهة.
3. إعداد SOP تشغيلي مختصر لفريق العمل.

---

## 18) خاتمة

هذا الإصدار V2 يحافظ على حقائق النظام الحالية كما هي، ويقدمها ببنية أوضح لتكون مرجعًا تشغيليًا وإداريًا موحدًا.
