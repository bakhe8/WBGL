# المواصفة الرئيسية الشاملة لتطوير نظام ضمانات بنكية (نسخة تكليف مطور جديد)

التاريخ: 2026-02-13  
لغة الوثيقة: العربية  
نوع الوثيقة: Product + Engineering Master Specification  
الغرض: تكليف مطور جديد ببناء نظام بنفس الفكرة التشغيلية بشكل واضح، دقيق، وقابل للتنفيذ دون غموض

---

## 1) الهدف العام من النظام

بناء نظام محلي Offline (جهاز واحد، مستخدم واحد) لإدارة دورة حياة الضمانات البنكية من لحظة الإدخال وحتى إصدار الخطاب الرسمي، مع سجل تاريخي تدقيقي كامل لكل خطوة تشغيلية.

النظام ليس مجرد شاشة إدخال، بل منصة تشغيل يومي تحقق:
- دقة إدخال البيانات.
- تسريع اتخاذ القرار.
- توثيق كل حدث تشغيلي.
- إمكانية مراجعة الحالة السابقة في أي وقت.
- إخراج رسمي موحد للخطابات.

---

## 2) الرؤية التشغيلية المختصرة

الرحلة التشغيلية الأساسية:
إدخال بيانات الضمان (Excel / يدوي / لصق ذكي) → مطابقة البنك والمورد → قرار (جاهز/يحتاج مراجعة) → إجراء تشغيلي (تمديد/تخفيض/إفراج) → توليد خطاب رسمي → تتبع تاريخي كامل.

مبدأ حاكم: أي تغيير تشغيلي مهم يجب أن ينعكس في Timeline مع Snapshot قبل التغيير.

---

## 3) افتراضات البيئة التشغيلية

هذا الإصدار مبني على افتراضات محددة يجب احترامها:

1. النظام يعمل Offline بالكامل.
2. مستخدم واحد فقط.
3. جهاز واحد فقط.
4. لا توجد متطلبات صلاحيات متعددة المستخدمين في المرحلة الحالية.
5. الأمان المتقدم (جلسات، CSRF، صلاحيات متعددة) يمكن تأجيله لمرحلة توسع لاحقة.

ملاحظة مهمة: تأجيل الأمان المتقدم لا يعني تجاهل جودة الكود أو الاتساق؛ فقط يعني خفض أولوية آليات الحماية الشبكية المعقدة في هذه المرحلة.

---

## 4) نطاق العمل (Scope)

### 4.1 داخل النطاق (In Scope)
- إدارة الضمانات البنكية.
- إدخال عبر 3 قنوات: Excel، يدوي، لصق ذكي.
- مطابقة بنك (حتمية) + مطابقة مورد (اقتراحات متعلمة).
- حالات تشغيلية: pending / ready / released (locked).
- إجراءات: تمديد، تخفيض، إفراج.
- Timeline + Snapshot لكل حدث.
- ملاحظات ومرفقات.
- نظام دفعات.
- إعدادات تشغيل وحفظها.
- صفحة إحصائيات تشغيلية.
- توليد خطابات رسمية موحدة.

### 4.2 خارج النطاق (Out of Scope) في هذه المرحلة
- نظام مستخدمين وصلاحيات معقد.
- بنية سحابية متعددة العملاء.
- تكاملات خارجية مع أنظمة بنكية مباشرة.
- ML متقدم خارج سياق قواعد التعلم الحالي.

---

## 5) الشخصيات المستهدفة (Personas)

1. مشغل النظام (Operator):
   - يدخل البيانات، يراجع المطابقات، يتخذ قرار، ينفذ إجراء.

2. مالك النظام (Owner):
   - يتابع جودة التشغيل، يراجع التقارير، يضبط الإعدادات.

3. مدقق داخلي (Internal Auditor):
   - يراجع Timeline، يتتبع منطق التغييرات، ويقارن قبل/بعد.

---

## 6) القواعد التشغيلية الحاكمة (Business Rules)

### 6.1 قاعدة الحالة
- ready إذا كان supplier_id موجود و bank_id موجود.
- pending في أي حالة أخرى.
- released فقط بعد تنفيذ إفراج من سجل جاهز.

### 6.2 قاعدة القفل
- بعد الإفراج يصبح السجل locked.
- لا يسمح بتمديد/تخفيض لسجل released/locked.

### 6.3 قاعدة التكرار
- عند إدخال رقم ضمان موجود عبر Excel أو Smart Paste:
  - لا يتم إنشاء سجل جديد.
  - يسجل حدث تكرار (Duplicate Import Event).
- في الإدخال اليدوي:
  - التكرار يرفض قبل الإنشاء.

### 6.4 قاعدة البنك غير المعروف
- لا يتم رفض الإدخال تلقائيًا فقط لعدم وجود تطابق بنكي.
- يمكن حفظ الضمان مع pending حتى استكمال المطابقة لاحقًا.

### 6.5 قاعدة الخطابات
- الخطاب الرسمي ينتج من مصدر موحد للبناء والقالب.
- كل إجراء له خطاب مطابق بصيغة قياسية.

---

## 7) المتطلبات الوظيفية التفصيلية

## FR-01 إدارة الضمانات (Core Guarantees)

المطلوب:
- إنشاء/قراءة/عرض ضمانات.
- حفظ البيانات الخام كما وردت من المصدر.
- ربط كل ضمان بقرار واحد فعال في جدول القرارات.

متطلبات دقيقة:
- رقم الضمان فريد.
- تتبع توقيت الإدخال ومن أدخل.
- ربط كل ضمان بBatch أو مصدر إدخال.

مخرجات مقبولة:
- يمكن عرض أي ضمان مع بياناته الخام والمرجعية والقرار الحالي.

---

## FR-02 الإدخال عبر Excel

المطلوب:
- رفع ملفات xlsx/xls.
- كشف ذكي لرؤوس الأعمدة.
- قراءة متعددة الصفوف.
- رفض الصفوف غير المكتملة مع سبب واضح.
- معالجة التكرار بدون إنشاء جديد.

سياسة المعالجة:
- صف مكتمل + جديد → إنشاء سجل.
- صف مكتمل + مكرر → تسجيل تكرار فقط.
- صف ناقص → skip مع سبب.

المخرجات:
- imported count
- duplicates count
- skipped details
- errors details

---

## FR-03 الإدخال اليدوي

المطلوب:
- نموذج إدخال مباشر للحقول الأساسية.
- تحقق من الحقول الإلزامية.
- رفض مباشر عند تكرار رقم الضمان.
- إنشاء سجل جديد عند الصحة.

الحقول الإلزامية المقترحة:
- رقم الضمان
- المورد
- البنك
- القيمة
- تاريخ الانتهاء
- رقم العقد/المرجع

---

## FR-04 اللصق الذكي (Smart Paste)

المطلوب:
- استقبال نص حر.
- استخراج حقول الضمان عبر أنماط extraction.
- حساب مستوى ثقة للاستخراج.
- إنشاء جديد أو معالجة مكرر.

قواعد:
- الحقول الناقصة تعاد للمستخدم مع سبب.
- لا يتم إنشاء سجل ناقص الحقول الحرجة.

---

## FR-05 المطابقة البنكية

المطلوب:
- مطابقة بنك حتمية deterministic من مرجع البنوك.
- دعم أسماء بديلة normalized.

قواعد:
- نجاح المطابقة يثبت bank_id.
- فشل المطابقة لا يلغي السجل، يبقيه pending.

---

## FR-06 مطابقة المورد والتعلم

المطلوب:
- محرك اقتراحات مورد مع score/confidence.
- عرض أفضل اقتراحات.
- تسجيل قرار المستخدم (confirm/reject).

قواعد التعلم:
- confirm يرفع موثوقية النمط.
- reject يخفض موثوقية النمط.
- يمكن إدارة الأنماط من الإعدادات.

---

## FR-07 القرارات (Decision Layer)

المطلوب:
- لكل ضمان صف قرار واحد نشط.
- القرار يحتوي supplier_id, bank_id, status, active_action.

قواعد:
- أي تحديث قرار يجب أن يحدث عبر مسار موحد.
- تقييم الحالة لا يتكرر في أكثر من مكان بمنطق مختلف.

---

## FR-08 الإجراءات التشغيلية (Extend / Reduce / Release)

### تمديد
- متاح فقط في ready وغير locked.
- يغير expiry_date.
- يسجل حدث تعديل.

### تخفيض
- متاح فقط في ready وغير locked.
- المبلغ الجديد يجب أن يكون أقل من الحالي.
- يسجل حدث تعديل.

### إفراج
- متاح فقط في ready.
- يحول الحالة إلى released.
- يفعّل lock.
- ينتج خطاب إفراج.

---

## FR-09 Timeline + Snapshot

المطلوب:
- كل حدث تشغيلي مهم يُسجل.
- قبل أي تغيير: حفظ Snapshot قبل التنفيذ.
- عند استعراض حدث: عرض حالة قبل الحدث.

أنواع الأحداث الدنيا:
- import
- duplicate_import
- decision_change
- status_transition
- extend
- reduce
- release
- note_added
- attachment_added

قواعد:
- لا تسجل Timeline Event بدون guarantee_id فعلي.
- سجل الرفض قبل الإنشاء إما خارج Timeline أو في channel منفصل.

---

## FR-10 Notes & Attachments

المطلوب:
- إضافة ملاحظات مرتبطة بالضمان.
- رفع مرفقات مرتبطة بالضمان.
- تضمينها في المسار التاريخي.

قواعد:
- الملاحظة/المرفق لا يغيران status مباشرة.
- كل عملية إضافة توثق بوقت واضح.

---

## FR-11 نظام الدفعات

المطلوب:
- ربط السجلات بدفعة/مصدر إدخال.
- عرض قائمة دفعات.
- عرض تفاصيل الدفعة.
- طباعة دفعة.

قواعد:
- الدفعة layer تنظيمية فوق السجل الفردي.
- دعم عدادات (new vs duplicate وغيرها).

---

## FR-12 الإعدادات

المطلوب:
- واجهة إعدادات مركزية.
- حفظ دائم في ملف إعدادات محلي.
- تحميل القيم الافتراضية عند غياب القيم.

تشمل:
- عتبات المطابقة.
- أوزان scoring.
- إعدادات التعلم.
- المنطقة الزمنية.
- Production Mode.

---

## FR-13 Production Mode

المطلوب:
- منع إنشاء test data جديدة.
- استبعاد test data من القراءة والتقارير والطباعة.
- عدم حذف test data القائمة تلقائيًا.

قواعد:
- write guard على المسارات الأساسية.
- read filter شامل على المؤشرات والشاشات.

---

## FR-14 الخطابات الرسمية

المطلوب:
- Builder موحد + Template موحد.
- دعم أنواع الخطابات للإجراءات الحالية.
- معاينة قبل الطباعة.

قواعد:
- مبدأ مصدر موحد للحقيقة في بناء الخطابات.
- لا تعدد قوالب متعارضة لنفس الإجراء.

---

## FR-15 الإحصائيات

المطلوب:
- مؤشرات تشغيلية ومالية وزمنية.
- مؤشرات تعلم ومطابقة.
- مؤشرات دفعات.

قواعد:
- في Production Mode استبعاد test data.
- تحديث مؤشرات بناءً على قاعدة البيانات الفعلية.

---

## FR-16 التنقل والبحث

المطلوب:
- next/prev يعملان داخل الفلتر النشط.
- عند عدم وجود فلتر يعملان على كامل السجلات.
- البحث يتكامل مع التنقل.

قاعدة حاكمة:
- مرجعية السجل يجب أن تكون واحدة في الفورم والTimeline والانتقال.

---

## 8) المتطلبات غير الوظيفية (NFR)

### NFR-01 الأداء
- فتح سجل وتشغيل الانتقال يجب أن يكون سريعًا وملائمًا للاستخدام اليومي.
- الاستعلامات الأساسية مفهرسة.

### NFR-02 الاعتمادية
- عدم فقدان بيانات في العمليات الأساسية.
- أي فشل يجب أن يعطي رسالة مفهومة.

### NFR-03 القابلية للصيانة
- فصل طبقات (API / Service / Repository / View).
- منع تكرار المنطق في أكثر من endpoint.

### NFR-04 قابلية التدقيق
- وجود Timeline كامل مع timestamp ومصدر التغيير.
- إمكانية إعادة بناء تسلسل القرار من السجلات.

### NFR-05 قابلية الاختبار
- وجود اختبارات smoke على الأقل.
- وجود حالات اختبار حرجة للمسارات الأساسية.

---

## 9) التصميم المعماري المقترح

### 9.1 الطبقات
1. Presentation Layer (Views + JS)
2. API Layer (endpoints)
3. Application Services (business orchestration)
4. Domain Rules (status/action logic)
5. Repositories (DB access)
6. Storage (SQLite + settings JSON + attachments)

### 9.2 مبادئ هندسية
- Single Responsibility لكل خدمة.
- مصدر واحد لقواعد الحالة.
- مصدر واحد لمرجعية التنقل.
- API contracts موحدة.

### 9.3 المعاملات (Transactions)
- عمليات create/update الحساسة تكون ضمن transaction عند الحاجة.
- event logging لا يضيع بين snapshot وupdate.

---

## 10) نموذج البيانات (Data Model) المقترح

## 10.1 جدول guarantees
حقول مقترحة:
- id (PK)
- guarantee_number (UNIQUE)
- raw_data (JSON/TEXT)
- import_source
- imported_at
- imported_by
- is_test_data (0/1)
- test_batch_id (nullable)
- test_note (nullable)

فهارس:
- unique على guarantee_number
- index على imported_at

## 10.2 جدول guarantee_decisions
- id (PK)
- guarantee_id (UNIQUE FK)
- supplier_id (nullable)
- bank_id (nullable)
- status (pending/ready/released)
- decision_source
- decided_by
- decided_at
- is_locked
- locked_reason
- active_action
- active_action_set_at
- last_modified_by
- last_modified_at

## 10.3 جدول guarantee_history
- id (PK)
- guarantee_id (FK)
- event_type
- event_subtype
- snapshot_data (JSON)
- event_details (JSON)
- letter_snapshot (nullable)
- created_at
- created_by

## 10.4 جداول مرجعية
- banks
- bank_alternative_names
- suppliers

## 10.5 جداول إضافية
- guarantee_notes
- guarantee_attachments
- guarantee_occurrences
- batch_metadata
- learning_confirmations / learning_patterns / learning_decisions

---

## 11) واجهات الاستخدام (UI/UX) المطلوبة

### 11.1 شاشة الضمان الأساسية
يجب أن تحتوي:
- معلومات الضمان الأساسية.
- المورد والبنك والحالة.
- أزرار الإجراءات (حفظ/تمديد/تخفيض/إفراج) مع gating حسب الحالة.
- Timeline جانبي.
- معاينة الخطاب.

### 11.2 شاشة الإعدادات
- تبويب عام للإعدادات.
- تبويب بنوك (CRUD + import/export).
- تبويب موردين (CRUD + import/export).
- تبويب تعلم.

### 11.3 شاشة الدفعات
- قائمة دفعات.
- تفاصيل دفعة.
- طباعة.

### 11.4 شاشة الإحصائيات
- بطاقات مؤشرات عامة.
- تحليلات زمنية وتشغيلية.
- تحليلات تعلم.

---

## 12) مواصفات API (High-Level Contract)

مبدأ عام:
- كل endpoint يجب أن يكون واضح الطلب/الرد/الأخطاء.
- توحيد شكل الاستجابة قدر الإمكان.

أمثلة endpoints:
- POST /api/import
- POST /api/create-guarantee
- POST /api/parse-paste
- POST /api/save-and-next
- POST /api/extend
- POST /api/reduce
- POST /api/release
- GET /api/get-record
- GET /api/get-timeline
- POST /api/save-note
- POST /api/upload-attachment
- GET/POST /api/settings

صيغة استجابة موحدة مقترحة:
- success: bool
- data: object|null
- error: code/message عند الفشل

---

## 13) الأخطاء وحالات الفشل (Error Handling)

قواعد إلزامية:
- كل فشل متوقع له رسالة تشغيلية مفهومة.
- لا تسريب stack traces للواجهة.
- log داخلي يكفي للتشخيص.

أمثلة:
- Missing required fields
- Duplicate guarantee number
- Invalid amount for reduction
- Action not allowed in current status
- Record not found

---

## 14) السجلات والتتبع (Logging & Observability)

المطلوب:
- log للأحداث التشغيلية المهمة.
- log للأخطاء مع سياق كاف.
- تمييز مستويات logs (debug/info/warn/error).

في Production Mode:
- إيقاف debug.
- إبقاء info/warn/error.

---

## 15) خطة الاختبارات المطلوبة

## 15.1 Smoke Tests (إلزامي)
- تشغيل إطار الاختبار بنجاح.
- اختبار بسيط يؤكد سلامة pipeline.

## 15.2 Unit Tests أساسية
- StatusEvaluator rules.
- Action gating rules.
- Duplicate logic.

## 15.3 Integration Tests
- save-and-next flow.
- get-record + get-timeline consistency.
- import + duplicate event behavior.

## 15.4 UAT سيناريوهات قبول
1. إدخال Excel مع جديد ومكرر وناقص.
2. إدخال يدوي مكرر (رفض).
3. Smart Paste مكتمل/ناقص.
4. الانتقال داخل pending filter دون تضارب timeline.
5. تنفيذ extend/reduce/release وفق الشروط.
6. إنتاج خطاب بعد release.

---

## 16) خطة التسليم المرحلية (Delivery Plan)

### Phase A: Foundation
- إعداد المشروع، DB schema، migrations.
- setup settings + basic logging.

### Phase B: Core Flows
- create/import/paste + duplicate handling.
- decision/status engine.

### Phase C: Actions + Timeline
- extend/reduce/release.
- snapshot/event recording.

### Phase D: UI Completion
- screens + navigation + filters + timeline panel.

### Phase E: Reporting & Docs
- statistics, batch views, letter generation.
- تسليم الوثائق النهائية.

---

## 17) معايير القبول النهائية (Go-Live Acceptance)

يعتبر المشروع مقبولاً إذا تحقق:

1. كل القنوات الثلاث تعمل حسب القواعد.
2. لا يوجد تضارب بين السجل المعروض والTimeline أثناء التنقل.
3. قواعد الحالة والإجراءات مطبقة بدون كسر.
4. الخطابات تنتج من مصدر موحد.
5. Production Mode يحقق write block + read filtering.
6. الاختبارات الأساسية تعمل (smoke + critical paths).
7. الوثائق محدثة وتعكس السلوك الفعلي.

---

## 18) قائمة مخرجات يجب طلبها من المطور (Deliverables)

1. مخطط معماري واضح (Architecture Diagram).
2. ERD أو Data Model موثق.
3. API Contract Document.
4. دليل تشغيل محلي (Runbook).
5. دليل إعدادات (Settings Guide).
6. تقرير اختبار مع نتائج فعلية.
7. قائمة Known Limitations.
8. خطة توسع مستقبلية (اختيارية).

---

## 19) قرارات تصميم يجب تثبيتها مبكرًا

1. Contract موحد لردود API.
2. مصدر واحد لقواعد الحالة.
3. مصدر واحد لمرجعية التنقل.
4. سياسة رفض ما قبل الإنشاء مقابل Timeline.
5. سياسة التعامل مع البيانات الاختبارية.

أي تأخير في هذه القرارات سيزيد إعادة العمل لاحقًا.

---

## 20) مخاطر متوقعة وكيفية إدارتها

### خطر 1: تكرار المنطق في أكثر من endpoint
- المعالجة: نقل القواعد لخدمات مركزية.

### خطر 2: تضارب التنقل مع الفلاتر
- المعالجة: NavigationService موحد لكل القنوات.

### خطر 3: انجراف الوثائق عن الواقع
- المعالجة: update docs إلزامي مع كل تغيير سلوكي.

### خطر 4: نمو سريع بلا اختبارات
- المعالجة: smoke + critical tests من البداية.

---

## 21) نص تكليف جاهز (يمكن نسخه للمطور)

المطلوب منك بناء نظام محلي Offline لإدارة الضمانات البنكية بنفس الفكر التشغيلي التالي:
- إدخال عبر Excel/يدوي/لصق ذكي.
- مطابقة بنك حتمية ومطابقة مورد متعلمة.
- قرار واحد لكل ضمان مع حالات pending/ready/released.
- إجراءات تشغيلية: تمديد، تخفيض، إفراج مع قيود حالة واضحة.
- Timeline تدقيقي كامل مع Snapshot قبل كل حدث.
- خطابات رسمية موحدة عبر builder/template ثابت.
- نظام دفعات، إعدادات، وإحصائيات تشغيلية.

الأولوية: صحة التشغيل والاتساق، ثم سهولة الصيانة.
ممنوع وجود منطق متعارض للحالة أو التنقل أو تسجيل الحدث.

التسليم المطلوب: كود + اختبارات أساسية + وثائق تشغيل/معمارية/واجهات API.

---

## 22) خاتمة تنفيذية

هذه المواصفة مكتوبة لتقليل التأويل الشخصي للمطور الجديد.
إذا التزم بها كما هي، ستخرج نسخة مستقرة، قابلة للتدقيق، وقريبة جدًا من احتياج التشغيل اليومي الفعلي، مع أساس هندسي أفضل للنمو المستقبلي دون إعادة بناء كاملة.
