# WBGL — Audit / Legal-Safe Report

**التاريخ:** 2026-02-13  
**النسخة:** Audit / Legal-Safe  
**الغرض:** توصيف تدقيقي محايد لسلوك النظام الفعلي دون أحكام تقييمية.

---

## 1) نطاق النظام

- النظام يدير دورة حياة الضمان البنكي من الإدخال حتى تنفيذ الإجراء وإنتاج الخطاب.
- النظام يعمل عبر واجهات تشغيلية وواجهات API ضمن نفس بيئة التطبيق.
- النظام يسجل الوقائع التشغيلية ضمن Timeline لكل ضمان.

---

## 2) قنوات الإدخال

- استيراد Excel عبر `api/import.php`.
- إدخال يدوي عبر `api/create-guarantee.php`.
- لصق ذكي عبر `api/parse-paste.php`.

### سلوك مشترك
- عند الإدخال الناجح، يتم تسجيل حدث استيراد في Timeline.
- عند وجود تكرار لنفس الضمان عبر **Excel أو اللصق الذكي**، يتم تسجيل حدث استيراد مكرر.
- حدث الاستيراد المكرر لا ينشئ كيانًا جديدًا لنفس رقم الضمان.
- في الإدخال اليدوي، التكرار يُرفض مباشرة عند التحقق من رقم الضمان قبل الإنشاء.

---

## 3) قواعد المطابقة

### 3.1 مطابقة البنك
- مطابقة البنك آلية.
- المطابقة تعتمد على بيانات البنوك الموجودة في النظام.
- عند عدم وجود تطابق بنكي، يُنشأ الضمان وتبقى المطابقة البنكية غير مكتملة إلى أن يتم تحديث البيانات المرجعية أو اتخاذ قرار لاحق.

### 3.2 مطابقة المورد
- مطابقة المورد تعتمد على اقتراحات بدرجات ثقة.
- المستخدم يستطيع الاعتماد أو التعديل أو الإضافة أثناء المطابقة.
- قرارات المستخدم تُستخدم ضمن آلية التعلم الخاصة بالمورد.

---

## 4) Timeline و Snapshot

- Timeline يسجل جميع الأحداث التشغيلية المرتبطة بالضمان.
- قبل كل حدث، يقوم النظام بحفظ Snapshot كامل للكيان.
- عند فتح حدث من Timeline، تُعرض الحالة السابقة للحدث من الـSnapshot.

---

## 5) الإجراءات التشغيلية المعتمدة

- الإجراءات المعتمدة حاليًا: تمديد، تخفيض، إفراج.
- الإفراج هو الإجراء الذي يحول الحالة من جاهز إلى مفرج عنه.
- بعد الإفراج يصبح الضمان مقفلًا (Locked).

---

## 6) الاستيراد المكرر

- النظام يسجل Duplicate Import عند محاولة إدخال ضمان موجود مسبقًا عبر **Excel** أو **Smart Paste**.
- عند التكرار، يسجل النظام حدث Duplicate Import في Timeline.
- تسجيل التكرار يثبت الواقعة التشغيلية دون تعديل كيان الضمان القائم.

---

## 7) Production Mode

- عند تفعيل `PRODUCTION_MODE`:
  - يمنع إنشاء بيانات اختبار جديدة عبر مسارات الإدخال الأساسية.
  - يفلتر بيانات الاختبار من القراءة في الشاشات والتقارير والطباعة.
  - لا يحذف بيانات الاختبار تلقائيًا من قاعدة البيانات.

---

## 8) البيانات المرجعية

- إدارة البنوك والموردين تتم من صفحة الإعدادات.
- العمليات المتاحة: عرض، إضافة، تعديل، حذف، استيراد، تصدير.
- بيانات البنوك والموردين تحفظ في قاعدة البيانات.

---

## 9) الإعدادات والحفظ

- إعدادات النظام تحفظ في `storage/settings.json`.
- تحميل/حفظ الإعدادات يتم عبر `api/settings.php`.
- القيم الافتراضية وقراءة الإعدادات تتم من `app/Support/Settings.php`.

---

## 10) صفحة الإحصائيات

- صفحة الإحصائيات: `views/statistics.php`.
- تعتمد على تجميعات من جداول التشغيل الأساسية.
- عند تفعيل Production Mode، تُعرض المؤشرات بعد استبعاد بيانات الاختبار.

---

## 11) المخرجات الرسمية (الخطابات)

- المخرج الرسمي للنظام هو خطاب بنكي مرتبط بالإجراء.
- الخطابات تبنى عبر مصدر موحد:
  - `app/Services/LetterBuilder.php`
  - `templates/letter-template.php`
- المتغيرات التشغيلية تُحقن داخل نموذج خطاب ثابت.

---

## 12) ملاحظات اعتماد

- هذه النسخة تصف السلوك التشغيلي للنظام بصياغة تدقيقية محايدة.
- لا تتضمن أحكام جودة أو درجات تقييم أو مقارنات معيارية.
