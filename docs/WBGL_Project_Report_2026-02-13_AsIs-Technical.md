# WBGL — As-Is Technical / Operational Report

**التاريخ:** 2026-02-13  
**النسخة:** As-Is Technical / Operational  
**الغرض:** وصف ما يفعله النظام حاليًا فقط.

---

## 1) تعريف النظام ونطاقه

- النظام يدير بيانات الضمانات البنكية.
- النظام يسجل الأحداث التشغيلية لكل ضمان في Timeline.
- النظام يولد خطابات مرتبطة بالإجراءات التشغيلية.

---

## 2) قنوات الإدخال

- Excel عبر `api/import.php`.
- إدخال يدوي عبر `api/create-guarantee.php`.
- لصق ذكي عبر `api/parse-paste.php`.

---

## 3) قواعد التكرار والرفض

- إذا كان رقم الضمان موجودًا مسبقًا في **Excel** أو **Smart Paste**، يعامل الإدخال كتكرار.
- التكرار في Excel/Smart Paste يسجل كحدث Duplicate Import في Timeline.
- التكرار لا ينشئ كيان ضمان جديد لنفس الرقم.
- في الإدخال اليدوي، تكرار رقم الضمان يُرفض قبل الإنشاء.
- في مطابقة البنك، إذا لم يوجد تطابق بنكي في البيانات المرجعية، يستمر الضمان بدون مطابقة بنك (pending) حتى التحديث أو المعالجة اللاحقة.

---

## 4) نظام Timeline

- Timeline يسجل جميع الأحداث التشغيلية.
- الأحداث تشمل الاستيراد، المطابقة، تغيرات الحالة، والإجراءات.
- يمكن فتح الحدث من الواجهة لعرض حالته السابقة.

---

## 5) Snapshot (كيان كامل)

- قبل تنفيذ أي حدث تشغيلي، يتم حفظ Snapshot كامل للضمان.
- الـSnapshot يستخدم لعرض الحالة السابقة عند استعراض الحدث.

---

## 6) الإجراءات الحالية (3 فقط)

- تمديد
- تخفيض
- إفراج

- الإفراج يغير الحالة من جاهز إلى مفرج عنه ثم يجعل الضمان Locked.

- أي إجراء آخر مذكور هو إجراء مستقبلي غير منفذ حاليًا.

---

## 7) Production Mode

- يمنع إنشاء بيانات اختبار جديدة عند تفعيله.
- يفلتر بيانات الاختبار من الشاشات والتقارير والطباعة.
- لا يحذف بيانات الاختبار تلقائيًا من قاعدة البيانات.

---

## 8) البيانات المرجعية

- إدارة البنوك والموردين تتم من صفحة الإعدادات (`views/settings.php`).
- العمليات المتاحة: عرض، إضافة، تعديل، حذف، استيراد JSON، تصدير JSON.
- بيانات البنوك والموردين تحفظ في قاعدة البيانات.

---

## 9) المطابقة

### 9.1 مطابقة البنك
- آلية فقط.
- تعتمد على بيانات البنوك الموجودة مسبقًا.

### 9.2 مطابقة المورد
- تعرض اقتراحات مع درجات ثقة.
- تسمح بالاعتماد أو التعديل أو الإضافة أثناء المطابقة.
- تستخدم قرارات المستخدم السابقة ضمن آلية التعلم.

---

## 10) الإعدادات

- إعدادات النظام تحفظ في `storage/settings.json`.
- حفظ/قراءة الإعدادات عبر `api/settings.php`.
- القيم الافتراضية من `app/Support/Settings.php`.

---

## 11) صفحة الإحصائيات

- صفحة الإحصائيات: `views/statistics.php`.
- تقرأ من جداول التشغيل الأساسية.
- في وضع الإنتاج تطبق فلترة بيانات الاختبار على المؤشرات.

---

## 12) المخرجات الرسمية

- المخرج الرسمي للنظام هو خطاب بنكي مرتبط بالإجراء.
- بناء الخطابات يتم عبر:
  - `app/Services/LetterBuilder.php`
  - `templates/letter-template.php`
