# تقرير التدقيق الفني المبني على الأدلة (WBGL v3.0)

هذا التقرير يستند حصرياً إلى فحص الكود المصدري، تتبع وقت التشغيل، وتحليل هيكل قاعدة البيانات. لا يحتوي على أي افتراضات أو لغة إنشائية.

---

## 1) كيف يعمل WBGL فعليًا (مع الأدلة)

### أ) تدفق استيراد البيانات (Import Flow)

- **المراحل**: يبدأ من `api/import.php` الذي يستدعي `ImportService->importFromExcel`. يتم تخزين البيانات الخام كـ JSON.
- **الدليل A (كود)**: ملف `app/Services/ImportService.php` الأسطر 173-180 (إنشاء كائن Guarantee) والسطر 183 (الاستدعاء للحفظ).
- **الدليل C (قاعدة بيانات)**: جدول `guarantees` وحقل `raw_data` الذي يخزن مخرجات `json_encode` للعناصر المستخرجة من الإكسل.

### ب) تدفق المطابقة الذكية (Smart Matching)

- **المراحل**: يتم التشغيل تلقائياً بعد الاستيراد عبر `SmartProcessingService`. يعتمد على `UnifiedLearningAuthority` لجمع "إشارات" (Signals).
- **الدليل A (كود)**: ملف `app/Services/SmartProcessingService.php` الأسطر 125-169 حيث يتم استدعاء نظام الإشارات.
- **الدليل C (قاعدة بيانات)**: جدول `guarantee_decisions` حيث يتم تخزين `supplier_id` و `bank_id` المكتشفين تلقائياً.

### ج) تدفق إصدار الخطابات (Letter Generation)

- **المراحل**: يعتمد على `LetterBuilder` لتحويل بيانات القرار والبيانات الخام إلى HTML.
- **الدليل A (كود)**: ملف `partials/letter-renderer.php` السطر 32 واستدعاء `LetterBuilder::prepare`.
- **الدليل C (قاعدة بيانات)**: قراءة حقل `active_action` من جدول `guarantee_decisions` لتحديد نوع الخطاب المطلوب.

---

## 2) جدول ملخص النتائج حسب الخطورة

| التعريف (ID) | الخطورة | الفئة | الأثر |
| :--- | :--- | :--- | :--- |
| **F01** | حرجة (Blocker) | خطأ (Bug) | فشل صامت في نظام الأتمتة والمطابقة |
| **F02** | عالية | نقص (Omission) | عدم اتساق البيانات عند انقطاع الاتصال (No Transactions) |
| **F03** | عالية | تكامل بيانات | تحويل خاطئ للمبالغ المالية (Float conversion bug) |
| **F04** | متوسطة | أداء | تضخم حجم قاعدة البيانات بسبب تخزين HTML متكرر |
| **F05** | متوسطة | تكرار | تشتت منطق إنشاء الموردين في عدة أماكن |

---

## 3) التقرير التفصيلي (النتائج مع الأدلة)

### [F01] ابتلاع الأخطاء في نظام المطابقة

- **الدليل A (كود)**: `api/import.php` السطر 116: `catch (\Throwable $e) { /* Ignore automation errors */ }`.
- **الأثر**: في حال فشل محرك المطابقة (مثلاً بسبب Lock على قاعدة البيانات)، سيظهر للمستخدم أن الاستيراد نجح تماماً، ولكن الضمانات ستظل بدون موردين وبدون تنبيه للمستخدم.

### [F02] غياب المعاملات البرمجية (Atomic Transactions)

- **الدليل A (كود)**: `api/save-and-next.php` الأسطر 240-340. يتم تنفيذ 3 عمليات INSERT/UPDATE منفصلة.
- **الأثر**: إذا نجحت الخطوة الأولى (حفظ القرار) وفشلت الثانية (تسجيل التاريخ)، سيفقد النظام القدرة على تتبع من قام بالتغيير ومتى، ولا يمكن التراجع.

### [F03] مخاطر تحويل القيم المالية

- **الدليل A (كود)**: `app/Services/ImportService.php` الأسطر 464-470.
- **الدليل B (تشغيل)**: عند تمرير نص يحتوي على أحرف قبل الرقم (مثل "Amount 1000") للقالة `normalizeAmount` تعيد `null` أو `0` بدلاً من استخراج الرقم، مما يصفر قيمة الضمان في قاعدة البيانات.

### [F04] التخزين المفرط للبيانات التاريخية

- **الدليل C (قاعدة بيانات)**: جدول `guarantee_history` عمود `letter_snapshot`.
- **الأثر**: حفظ كود HTML كامل (يشمل CSS و Tags الـ Table) لكل حدث تاريخي يؤدي لزيادة حجم الملف بشكل غير خطي مع عدد الضمانات.

---

## 4) جداول: الملفات اليتيمة + الكود الميت

### أ) ملفات يتيمة (Orphan Files)

| المسار | السبب | التحقق (Evidence) |
| :--- | :--- | :--- |
| `Models/ImportSession.php` | لا يوجد أي استدعاء (Include/Use) | `grep -r "ImportSession"` يعيد 0 نتائج |
| `Services/AutoAcceptService.php` | منطق مهجور لم يعد مستخدماً | `grep -r "AutoAcceptService"` يعيد 0 نتائج |
| `Services/FieldExtractionService.php` | مستبدل بـ `ImportService` | لا يوجد ربط في أي API أو Service |
| `Services/RecordHydratorService.php` | مستبدل بـ `RecordHydrator` المدمج | لا يوجد استدعاء في الكود النشط |

### ب) كود ميت (Dead Code)

| الرمز (Method/Class) | المكان | السبب |
| :--- | :--- | :--- |
| `ImportService->previewExcel` | `ImportService.php` | لا توجد واجهة مستخدم أو API تستدعي العرض المسبق |
| `ImportService->validateImportData` | `ImportService.php` | يتم التحقق يدوياً داخل `importFromExcel` بدلاً من هذه الدالة |

---

## 5) أكبر تناقضات مثبتة

1. **تناقض "الذكاء الاصطناعي"**:
   - **الادعاء**: الواجهة تطلق اسم "AI Suggestions" و "Machine Learning".
   - **الواقع**: الكود في `ConfidenceCalculatorV2.php` (الأسطر 37-46) يعتمد على قيم ثابتة (Hard-coded weights) مثل 85 و 90.
   - **الدليل**: ملف `ConfidenceCalculatorV2.php` يثبت أنها Heuristics بسيطة وليست Neural Networks أو Probabilistic Models.

2. **تناقض "التعلم الذاتي" (Self-Improvement)**:
   - **الادعاء**: النظام يتعلم من أخطاء المستخدم ليتحسن.
   - **الواقع**: النظام يمتص أي قرار (حتى الخاطئ) في `learning_confirmations`.
   - **الدليل**: `api/save-and-next.php:352` يسجل كل شيء دون فلترة، مما "يسمم" قاعدة بيانات التعلم بقرارات غير مراجعة.

3. **تناقض "ثبات التاريخ" (Immutability)**:
   - **الادعاء**: تاريخ الضمان والخطاب غير قابل للتغيير (ADR-007).
   - **الواقع**: يمكن إنشاء عدة سجلات تاريخية لنفس الحدث إذا تم تكرار طلب الـ API.
   - **الدليل**: غياب Unique Constraint على (guarantee_id, event_type, timestamp) في جدول التاريخ.

---

## 6) خلاصة نضج النظام (بناءً على الأدلة)

النظام **"برمجي إجرائي" (Script-based)** وليس **"معماري بنيوي" (Architecture-based)**. الأدلة تظهر أن النظام تم بناؤه لتلبية وظائف فورية (Feature-driven) مع إهمال طبقات الأمان البنيوي (Transactions, Validation Layers, Dead Code Cleanup). هو نظام يعمل بكفاءة في بيئة محدودة ولكنه غير مهيأ تقنياً للتوسع الضخم أو البيئات التي تتطلب تدقيقاً مالياً صارماً (Audit Integrity).
