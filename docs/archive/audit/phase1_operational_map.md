# ุงููุฑุญูุฉ ุงูุฃููู - ุงูููู ุงูุชุดุบููู ููุธุงู WBGL

## ุงูุชุงุฑูุฎ: 2026-02-11

---

## ๐ฏ ุงููุดููุฉ ุงูุชุดุบูููุฉ ุงูุชู ูุญููุง WBGL

### ุงูุณูุงู

**ุงููุณุชุดูู:** ูุณุชุดูู ุงูููู ููุตู ุงูุชุฎุตุตู ููุฑูุฒ ุงูุฃุจุญุงุซ - ุงูุฑูุงุถ

**ุงููุดููุฉ:**
ุงููุณุชุดูู ูุณุชูุจู **ุถูุงูุงุช ุจูููุฉ** ูู ุงูููุฑุฏูู ูุงูููุงูููู ุถูุงูุงู ููุนููุฏ ูุฃูุงูุฑ ุงูุดุฑุงุก. ูุฐู ุงูุถูุงูุงุช ุชุฃุชู ูู ุจููู ูุชุนุฏุฏุฉ ูุจุฃุณูุงุก ูุญุชููุฉ ููููุฑุฏูู (ุนุฑุจู/ุฅูุฌููุฒูุ ุงุฎุชุตุงุฑุงุชุ ุฃุฎุทุงุก ุฅููุงุฆูุฉ).

**ุงูุชุญุฏูุงุช:
**

1. **ุงุณุชูุฑุงุฏ**: ูููุงุช Excel ุชุญุชูู ุนูู ูุฆุงุช ุงูุถูุงูุงุช ุจุฃุณูุงุก ุบูุฑ ููุญุฏุฉ
2. **ูุทุงุจูุฉ ูุฏููุฉ**: ุงูููุธู ูุทุงุจู ูู ุงุณู ููุฑุฏ/ุจูู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุณููุฉ (ุจุทูุก ููุนุฑุถ ููุฎุทุฃ)
3. **ุชูููุฏ ุฎุทุงุจุงุช**: ูู ุถูุงู ูุญุชุงุฌ ุฎุทุงุจ ุฑุณูู (ุฅูุฑุงุฌุ ุชูุฏูุฏุ ุชุฎููุถ) ุจุตูุบุฉ ูุงููููุฉ ูุญุฏุฏุฉ
4. **ุชุชุจุน**: ูุชุงุจุนุฉ ุญุงูุฉ ูู ุถูุงู ูุชุงุฑูุฎู

**ุงูุญู (WBGL):**
ูุธุงู ุฐูู **ูุณุชูุฑุฏ ุงูุถูุงูุงุช ูู Excel**ุ **ูุทุงุจู ุชููุงุฆูุงู** ุงูููุฑุฏูู ูุงูุจููู ุจุงุณุชุฎุฏุงู AIุ **ูุชุนูู** ูู ูุฑุงุฑุงุช ุงููุณุชุฎุฏูุ **ูููุฏ ุฎุทุงุจุงุช ุฑุณููุฉ** ุฌุงูุฒุฉ ููุทุจุงุนุฉุ ููุชุชุจุน ูู ุงูุชุบููุฑุงุช.

---

## ๐บ๏ธ ุฎุฑูุทุฉ ุชุดุบูููุฉ ุดุงููุฉ (Operational Map)

### 1๏ธโฃ ููุงุท ุงูุฏุฎูู (Entry Points)

| ุงูููุทุฉ | ุงูููู | ุงููุธููุฉ |
|--------|------|---------|
| **ูุงุฌูุฉ ุงูููุจ ุงูุฑุฆูุณูุฉ** | `index.php` | ุนุฑุถ ุงูุถูุงูุงุชุ ุงุชุฎุงุฐ ุงููุฑุงุฑุงุชุ ูุนุงููุฉ ุงูุฎุทุงุจุงุช |
| **ุงุณุชูุฑุงุฏ Excel** | `api/import.php` | ุฑูุน ููู Excel ููุนุงูุฌุชู |
| **ุงุณุชูุฑุงุฏ ุฐูู (Smart Paste)** | `api/parse-paste-v2.php` | ูุตู ุจูุงูุงุช ููุณูุฎุฉ |
| **ุญูุธ ูุงูุชูุงู** | `api/save-and-next.php` | ุญูุธ ูุฑุงุฑ + ุชุญููู ุถูุงู ุชุงูู |
| **ุชูููุฐ ุฅุฌุฑุงุกุงุช** | `api/release.php`, `api/extend.php`, `api/reduce.php` | ุฅุตุฏุงุฑ ุฎุทุงุจุงุช |
| **ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช** | `views/batches.php` | ุนุฑุถ ูุฅุฏุงุฑุฉ ุงูุฏูุนุงุช |
| **ุงูุฅุญุตุงุฆูุงุช** | `views/statistics.php` | ุชูุงุฑูุฑ ูุชุญูููุงุช |
| **ุงูุฅุนุฏุงุฏุงุช** | `views/settings.php` + `api/settings.php` | ุชุนุฏูู ูุนุงููุฑ AI ูุงููุธุงู |

**ูุง ููุฌุฏ:**

- โ CLI Scripts
- โ Cron Jobs
- โ Background Workers
- โ Queue System

---

### 2๏ธโฃ ุงููุญุฏุงุช ุงูุฃุณุงุณูุฉ (Core Modules)

#### ุฃ) ูุญุฏุฉ ุงูุงุณุชูุฑุงุฏ (Import Module)

**ุงููุณุคูู:** `ImportService`, `BatchService`, `ExcelColumnDetector`, `FieldExtractionService`

**ุงููุธููุฉ:**

- ูุฑุงุกุฉ ูููุงุช Excel (PHPSpreadsheet)
- ูุดู ุชููุงุฆู ูุนูุงููู ุงูุฃุนูุฏุฉ (ุฐูู - ูุจุญุซ ูู ุฃูู 5 ุตููู)
- ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช: ุฑูู ุงูุถูุงูุ ุงูููุฑุฏุ ุงูุจููุ ุงููุจูุบุ ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ/ุงูุงูุชูุงุกุ ุงูุนูุฏุ ุงูููุน
- ุงูุชุญูู ูู ุงูุชูุฑุงุฑ (Duplicate Detection)
- ุฅูุดุงุก Batch Metadata

**ุงููุฎุฑุฌุงุช:**

- ุณุฌู ูู ุฌุฏูู `guarantees` (raw data ูู JSON)
- ุณุฌู ูู ุฌุฏูู `batch_metadata` (ูุนูููุงุช ุงูุฏูุนุฉ)
- ุณุฌู ูู ุฌุฏูู `guarantee_occurrences` (ุฑุจุท ุงูุถูุงู ุจุงูุฏูุนุฉ)

---

#### ุจ) ูุญุฏุฉ ุงููุทุงุจูุฉ ุงูุฐููุฉ (AI Matching Module)

**ุงููุณุคูู:** `AuthorityFactory`, `UnifiedLearningAuthority`, 5 Signal Feeders

**ุงููุธููุฉ:**
ูุทุงุจูุฉ ุฃุณูุงุก ุงูููุฑุฏูู ุงูุฎุงูุฉ (Raw) ูู Excel ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุณููุฉ.

**ุงูุขููุฉ (5 ูุตุงุฏุฑ ุฅุดุงุฑุงุช):**

1. **AliasSignalFeeder** (ุงูุฃุณูุงุก ุงูุจุฏููุฉ):
   - ุงูุจุญุซ ูู ุฌุฏูู `supplier_alternative_names`
   - ูุทุงุจูุฉ ูุจุงุดุฑุฉ ูุฃุณูุงุก ูุนุฑููุฉ ูุณุจูุงู
   - **ุงููุฒู:** 85% (ูุตุงุฏุฑ ููุซููุฉ)

2. **LearningSignalFeeder** (ุงูุชุนูู ุงูุขูู):
   - ูุฑุงุกุฉ ุฌุฏูู `learning_confirmations`
   - ุงูุงุนุชูุงุฏ ุนูู ุงููุฑุงุฑุงุช ุงูุณุงุจูุฉ
   - **ุงููุฒู:** 75% (ุชุนูู ูุญูู)

3. **FuzzySignalFeeder** (ุงูุชุทุงุจู ุงูุถุจุงุจู):
   - Levenshtein Distance
   - ูุทุงุจูุฉ ุชูุฑูุจูุฉ ูุฃุณูุงุก ูุดุงุจูุฉ
   - **ุงููุฒู:** 60% (ุชุฎููู ุจุณูุท)

4. **AnchorSignalFeeder** (ุงุณุชุฎุฑุงุฌ ุงูููุงูุงุช):
   - `ArabicEntityExtractor` - ุงุณุชุฎุฑุงุฌ ุฃุณูุงุก ุงูุดุฑูุงุช ุงูุนุฑุจูุฉ
   - ูุทุงุจูุฉ ุนูู ุฃุณุงุณ ุงููููุงุช ุงูููุชุงุญูุฉ
   - **ุงููุฒู:** ุฏููุงูููู

5. **HistoricalSignalFeeder** (ุงูุชุงุฑูุฎ):
   - ุฌุฏูู `guarantee_decisions`
   - ุงูุงุนุชูุงุฏ ุนูู ุงูุงุฎุชูุงุฑุงุช ุงูุณุงุจูุฉ ูููุณ ุงูุงุณู
   - **ุงููุฒู:** ูุฒูุฏ ูุน ุงูุชูุฑุงุฑ

**ConfidenceCalculatorV2**:

- ูุฌูุน ุงูุฅุดุงุฑุงุช ูู ุฌููุน ุงููุตุงุฏุฑ
- ูุญุณุจ ูุณุจุฉ ุงูุซูุฉ ุงูููุงุฆูุฉ
- ูุฑุชุจ ุงูุงูุชุฑุงุญุงุช

**ุงููุฎุฑุฌุงุช:**

- ูุงุฆูุฉ ููุชุฑุญุฉ ูู ุงูููุฑุฏูู ูุฑุชุจุฉ ุญุณุจ ุงูุซูุฉ
- ุนุฑุถ ุงููุชูุฌุฉ ูููุณุชุฎุฏู ุนูู ุงููุงุฌูุฉ

---

#### ุฌ) ูุญุฏุฉ ุงุชุฎุงุฐ ุงููุฑุงุฑ (Decision Module)

**ุงููุณุคูู:** `save-and-next.php`, `DecisionService`, `StatusEvaluator`

**ุงููุธููุฉ:**
ุงููุณุชุฎุฏู ูุฎุชุงุฑ (ุฃู ูุนุฏู) ุงูููุฑุฏ ูุงูุจูู ููู ุถูุงู.

**ุงูุชุฏูู ุงูุนููู:**

1. ุงููุณุชุฎุฏู ูุดุงูุฏ ุงูุถูุงู + ุงูุงูุชุฑุงุญุงุช AI
2. ูุฎุชุงุฑ ุงูููุฑุฏ (ุฃู ูุฏุฎู ุฌุฏูุฏ โ ูููุดุฃ ุชููุงุฆูุงู)
3. ูุญูุธ ุงููุฑุงุฑ โ ููุณุฌู ูู `guarantee_decisions`
4. ุงููุธุงู ูุญุฏุฏ ุงูุญุงูุฉ ุชููุงุฆูุงู:
   - **pending**: ูุง ููุฌุฏ ููุฑุฏ ุฃู ุจูู
   - **ready**: ุงูููุฑุฏ ูุงูุจูู ูุญุฏุฏุงู
   - **released**: ุชู ุฅุตุฏุงุฑ ุฎุทุงุจ ุงูุฅูุฑุงุฌ

**ุงูุฐูุงุก:**

- **Auto-Create Supplier**: ุฅุฐุง ุฃุฏุฎู ุงููุณุชุฎุฏู ุงุณู ููุฑุฏ ุฌุฏูุฏ โ ูููุดุฃ ุชููุงุฆูุงู
- **ID/Name Mismatch Detection**: ุฅุฐุง ุนุฏูู ุงููุณุชุฎุฏู ุงูุงุณู ุฏูู ุชุญุฏูุซ ID โ ุงููุธุงู ููุบู ID
- **Bank Auto-Match**: ุงูุจูู ููุญุฏุฏ ูุฑุฉ ูุงุญุฏุฉ ุฃุซูุงุก ุงูุงุณุชูุฑุงุฏ (ูุง ูุชุบูุฑ)

**ุงูุชุณุฌูู:**

- ุญุฏุซ Timeline (`TimelineRecorder::recordDecisionEvent`)
- Learning Feedback:
  - **Confirm**: ุชุณุฌูู ุงูููุงููุฉ ุนูู ุงูููุฑุฏ ุงูููุฎุชุงุฑ
  - **Reject**: ุชุณุฌูู ุฑูุถ ุงูุงูุชุฑุงุญ ุงูุฃูู (ุถููููุง ุฅุฐุง ุงุฎุชุงุฑ ุงููุณุชุฎุฏู ููุฑุฏ ุขุฎุฑ)

---

#### ุฏ) ูุญุฏุฉ ุงูุชุชุจุน (Timeline Module)

**ุงููุณุคูู:** `TimelineRecorder`, `TimelineDisplayService`

**ุงููุธููุฉ:**
ุชุณุฌูู ูู ุญุฏุซ ูุญุฏุซ ููุถูุงู ูู ุฌุฏูู `guarantee_timeline`.

**ุฃููุงุน ุงูุฃุญุฏุงุซ:**

| ุงูุฑูุฒ | ุงูููุน | ุงููุตู |
|------|------|-------|
| **IE-01** | Import | ุงุณุชูุฑุงุฏ ูู Excel |
| **IE-02** | Smart Paste | ูุตู ุฐูู |
| **ME-01** | Manual Entry | ุฅุฏุฎุงู ูุฏูู |
| **UE-01** | Decision | ูุฑุงุฑ ูุณุชุฎุฏู ูุฏูู |
| **UE-02** | Auto Decision | ูุฑุงุฑ ุชููุงุฆู (AI) |
| **SE-01** | Status: Pending โ Ready | ุชุบููุฑ ุงูุญุงูุฉ |
| **SE-02** | Status: Ready โ Pending | ุชุฑุงุฌุน ุนู ุฌุงูุฒูุฉ |
| **AE-01** | Extension | ุชูุฏูุฏ |
| **AE-02** | Reduction | ุชุฎููุถ |
| **AE-03** | Release | ุฅูุฑุงุฌ |
| **LE-01** | Lock | ููู |

**ุงูุงุณุชุฎุฏุงูุงุช:**

- ุนุฑุถ ุงูุณุฌู ุงูุฒููู ูููุณุชุฎุฏู
- Audit Trail (ูู ูุนู ูุงุฐุง ููุชู)
- Historical Snapshot (ุญุงูุฉ ุงูุถูุงู ูู ูุญุธุฉ ุฒูููุฉ)

---

#### ูู) ูุญุฏุฉ ุชูููุฐ ุงูุฅุฌุฑุงุกุงุช (Action Execution Module)

**ุงููุณุคูู:** `release.php`, `extend.php`, `reduce.php`

**ุงููุธููุฉ:**
ุชูููุฐ ุฅุฌุฑุงุกุงุช ุนูู ุงูุถูุงูุงุช ุงูุฌุงูุฒุฉ (status = ready).

**ุงูุฅุฌุฑุงุกุงุช:**

1. **Release (ุฅูุฑุงุฌ)**:
   - ุดุฑุท: ุงูุถูุงู ุฌุงูุฒ (ready) + ุบูุฑ ูููู
   - ุงูุชูููุฐ:
     - ุชุญุฏูุซ `guarantee_decisions.is_locked = 1`
     - ุชุญุฏูุซ `locked_reason = 'released'`
     - ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `released`
     - ุชุณุฌูู ุญุฏุซ Timeline (AE-03)
     - ุชูููุฏ ุฎุทุงุจ ุงูุฅูุฑุงุฌ

2. **Extend (ุชูุฏูุฏ)**:
   - ุดุฑุท: ready + ุบูุฑ ูููู + ูู ูููููุฐ ุฅุฌุฑุงุก ุณุงุจู
   - ุงูุชูููุฐ:
     - ุชุญุฏูุซ `guarantee.raw_data['expiry_date']` = ุชุงุฑูุฎ ุฌุฏูุฏ
     - ุชุญุฏูุซ `guarantee_decisions.active_action = 'extension'`
     - ุชุณุฌูู Timeline (AE-01)
     - ุชูููุฏ ุฎุทุงุจ ุงูุชูุฏูุฏ

3. **Reduce (ุชุฎููุถ)**:
   - ุดุฑุท: ready + ุบูุฑ ูููู + ูู ูููููุฐ ุฅุฌุฑุงุก ุณุงุจู
   - ุงูุชูููุฐ:
     - ุชุญุฏูุซ `guarantee.raw_data['amount']` = ูุจูุบ ุฌุฏูุฏ
     - ุชุญุฏูุซ `guarantee_decisions.active_action = 'reduction'`
     - ุชุณุฌูู Timeline (AE-02)
     - ุชูููุฏ ุฎุทุงุจ ุงูุชุฎููุถ

**Active Action State (ADR-007):**

- `active_action` ูุดูุฑ ุฅูู ุขุฎุฑ ุฅุฌุฑุงุก ููููุฐ
- ุฅุฐุง ุชุบูุฑุช ุงูุจูุงูุงุช โ ูููุณุญ `active_action` (ูุฃู ุงูุฎุทุงุจ ุงููุฏูู ูู ูุนุฏ ุตุญูุญุงู)

---

#### ู) ูุญุฏุฉ ุชูููุฏ ุงูุฎุทุงุจุงุช (Letter Generation Module)

**ุงููุณุคูู:** `LetterBuilder`, `PreviewFormatter`

**ุงููุธููุฉ:**
ุฅูุดุงุก ุฎุทุงุจุงุช ุฑุณููุฉ ุฌุงูุฒุฉ ููุทุจุงุนุฉ ุจุตูุบุฉ ูุงููููุฉ ุตุญูุญุฉ.

**ุงูุจููุฉ:**

- **Header**: ุงุณู ุงูุจูู + ุงููุฑูุฒ + ุตูุฏูู ุงูุจุฑูุฏ + ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- **Subject**: ููุน ุงูุฅุฌุฑุงุก + ุฑูู ุงูุถูุงู + ุฑูู ุงูุนูุฏ
- **Content**: ููุฑุงุช ุงูุฎุทุงุจ (ุชุฎุชูู ุญุณุจ ุงูููุน)
- **Signature**: ุงูุชูููุน (ูุฎุชูู ุญุณุจ ุงูููุน - Release ูู ุชูููุน ูุฎุชูู)
- **CC**: ูุณุฎุฉ ุฅูู (ููุท ูู Release)

**ุงููุฑููุงุช:**

| ุงูุฅุฌุฑุงุก | ุงูููุฑุงุช | ุตูุฏูู ุงูุนููุงู | ุงูุชูููุน |
|---------|---------|----------------|----------|
| **Release** | ููุฑุฉ ูุงุญุฏุฉ (ุฅุนุงุฏุฉ ุงูุถูุงู) | ูุง | ููุณุงุนูุฏ ุงูุฑุฆูุณ ุงูุชูููุฐู |
| **Extension** | ููุฑุชุงู (ุทูุจ ุงูุชูุฏูุฏ + ุชุญุฐูุฑ) | ูุนู | ููุฏูุฑ ุงูุฅุฏุงุฑุฉ ุงูุนุงูููุฉ ููุนูููููุงุช |
| **Reduction** | ููุณ Extension | ูุนู | ููุฏูุฑ ุงูุฅุฏุงุฑุฉ ุงูุนุงูููุฉ ููุนูููููุงุช |

**ุงููุฎุฑุฌุงุช:**

- HTML ุฌุงูุฒ ููุทุจุงุนุฉ
- ูุนุงููุฉ ูู ุงููุงุฌูุฉ
- PDF (ุนุจุฑ Print to PDF ูู ุงููุชุตูุญ)

---

### 3๏ธโฃ ุงูุชุฏููุงุช ุงูุนูููุฉ ุงูุฑุฆูุณูุฉ

#### ๐ Flow 1: ุงุณุชูุฑุงุฏ ููุนุงูุฌุฉ ุฏูุนุฉ Excel

```
1๏ธโฃ ุงููุณุชุฎุฏู ูุฑูุน ููู Excel
    โ
2๏ธโฃ ImportService ููุฑุฃ ุงูููู
    โ
3๏ธโฃ ExcelColumnDetector ููุชุดู ุงูุฃุนูุฏุฉ ุชููุงุฆูุงู
    โ
4๏ธโฃ FieldExtractionService ูุณุชุฎุฑุฌ ุงูุจูุงูุงุช
    โ
5๏ธโฃ ููู ูู ุตู:
    a. ุงูุชุญูู ูู ุงูุชูุฑุงุฑ (Duplicate Check)
    b. ุฅูุดุงุก ุณุฌู ูู `guarantees` (raw_data ูู JSON)
    c. ุฅูุดุงุก ุณุฌู ูู `guarantee_occurrences`
    d. ูุทุงุจูุฉ ุงูุจูู ุชููุงุฆูุงู (BankNormalizer + bank_alternative_names)
    e. ุฅูุดุงุก ุณุฌู ูู `guarantee_decisions` (bank_id ููุท)
    f. ุชุณุฌูู ุญุฏุซ Timeline (IE-01)
    โ
6๏ธโฃ BatchMetadataRepository ูุญูุธ ูุนูููุงุช ุงูุฏูุนุฉ
    โ
7๏ธโฃ ุงููุชูุฌุฉ: ุนุฏุฏ ุงููุณุชูุฑุฏุฉ + Skipped + Duplicates
```

---

#### ๐ฏ Flow 2: ุงุชุฎุงุฐ ูุฑุงุฑ ูุถูุงู ูุงุญุฏ

```
1๏ธโฃ index.php ูุนุฑุถ ุงูุถูุงู
    โ
2๏ธโฃ AuthorityFactory ูููุดุฆ UnifiedLearningAuthority
    โ
3๏ธโฃ Authority ูุฌูุน ุฅุดุงุฑุงุช ูู 5 Feeders:
    - AliasSignalFeeder
    - LearningSignalFeeder
    - FuzzySignalFeeder
    - AnchorSignalFeeder
    - HistoricalSignalFeeder
    โ
4๏ธโฃ ConfidenceCalculatorV2 ูุญุณุจ ูุณุจ ุงูุซูุฉ
    โ
5๏ธโฃ SuggestionFormatter ูููุณูู ุงูุงูุชุฑุงุญุงุช
    โ
6๏ธโฃ ุงูุนุฑุถ: ุฃุนูู 5 ุงูุชุฑุงุญุงุช ูููุณุชุฎุฏู
    โ
7๏ธโฃ ุงููุณุชุฎุฏู ูุฎุชุงุฑ (ุฃู ูุฏุฎู ุฌุฏูุฏ)
    โ
8๏ธโฃ AJAX POST ุฅูู save-and-next.php:
    a. ID/Name Mismatch Check
    b. Auto-Create Supplier (ุฅุฐุง ุฌุฏูุฏ)
    c. StatusEvaluator ูุญุฏุฏ ุงูุญุงูุฉ
    d. UPDATE ุฃู INSERT ูู `guarantee_decisions`
    e. TimelineRecorder ูุณุฌู Decision Event (UE-01)
    f. TimelineRecorder ูุณุฌู Status Transition (SE-01/02)
    g. LearningRepository ูุณุฌู Confirm + Reject
    h. ุฅุฑุฌุงุน ุงูุถูุงู ุงูุชุงูู (NavigationService)
    โ
9๏ธโฃ ุงููุงุฌูุฉ ุชูุญุฏูุซ ุชููุงุฆูุงู ุจุงูุถูุงู ุงูุชุงูู
```

---

#### ๐ Flow 3: ุชูููุฏ ุฎุทุงุจ ุฅูุฑุงุฌ

```
1๏ธโฃ ุงููุณุชุฎุฏู ูููุฑ "Release" ุนูู ุถูุงู ุฌุงูุฒ
    โ
2๏ธโฃ release.php ูุชุญูู ูู:
    - status = 'ready'
    - is_locked = 0
    - supplier_id ููุฌูุฏ
    - bank_id ููุฌูุฏ
    โ
3๏ธโฃ ุฅุฐุง ุงููุฌุงุญ:
    a. UPDATE guarantee_decisions:
       - is_locked = 1
       - locked_reason = 'released'
       - status = 'released'
    b. TimelineRecorder ูุณุฌู Release Event (AE-03)
    โ
4๏ธโฃ LetterBuilder.prepare():
    - ูููุดุฆ ุจููุฉ ุงูุจูุงูุงุช
    - buildHeader()
    - buildSubjectParts()
    - buildReleaseContent()
    - getSignature('release')
    - buildCC()
    โ
5๏ธโฃ LetterBuilder.render():
    - ููุญููู `templates/letter-template.php`
    - ููุนุจูุฆ ุงูุจูุงูุงุช
    - ููุฑุฌุน HTML
    โ
6๏ธโฃ API ุชุฑุฌุน:
    {
      "success": true,
      "letter_html": "...",
      "action": "release"
    }
    โ
7๏ธโฃ ุงููุงุฌูุฉ ุชุนุฑุถ ูุนุงููุฉ ุงูุฎุทุงุจ
    โ
8๏ธโฃ ุงููุณุชุฎุฏู ูุทุจุน (Ctrl+P โ PDF)
```

---

#### ๐ Flow 4: ูุนุงูุฌุฉ ุฏูุนุฉ ูุงููุฉ (Batch Extension)

```
1๏ธโฃ ุงููุณุชุฎุฏู ููุชุญ batch-detail.php?source=excel_20260210_123456
    โ
2๏ธโฃ BatchService.getBatchGuarantees(source):
    - ูุฌูุจ ุฌููุน ุงูุถูุงูุงุช ูู ุงูุฏูุนุฉ
    - JOIN ูุน guarantee_decisions
    - ุชุฑุชูุจ ุญุณุจ ID
    โ
3๏ธโฃ ุงูุนุฑุถ: ูุงุฆูุฉ ุงูุถูุงูุงุช + checkboxes
    โ
4๏ธโฃ ุงููุณุชุฎุฏู ูุญุฏุฏ ุถูุงูุงุช + ุชุงุฑูุฎ ุชูุฏูุฏ ุฌุฏูุฏ
    โ
5๏ธโฃ POST ุฅูู api/extend.php (batch mode):
    a. BatchService ูุชุญูู: ุงูุฏูุนุฉ ุบูุฑ ูุบููุฉ
    b. ููู ูู ุถูุงู ูุญุฏุฏ:
       - ุงูุชุญูู: ready + ุบูุฑ ูููู + ูุง ููุฌุฏ ุฅุฌุฑุงุก ุณุงุจู
       - ุชุญุฏูุซ expiry_date ูู raw_data
       - ุชุญุฏูุซ active_action = 'extension'
       - ุชุณุฌูู Timeline (AE-01)
    c. ุฅุญุตุงุฆูุงุช: Extended / Blocked / Errors
    โ
6๏ธโฃ ุงููุชูุฌุฉ: ุชูุฑูุฑ ุดุงูู ุจุงููุฌุงุญุงุช ูุงููุดู
```

---

#### ๐ Flow 5: ุงูุชุนูู ูู ุงููุฑุงุฑุงุช (Learning Loop)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุณุชุฎุฏู ูุญูุธ ูุฑุงุฑ (save-and-next)    โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Learning Check          โ
    โ - ูู ููุฌุฏ raw_data?    โ
    โ - ูู ููุฌุฏ supplier_id? โ
    โโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Step 1: LOG CONFIRMATION            โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
    โ INSERT INTO learning_confirmations  โ
    โ  - raw_supplier_name                โ
    โ  - supplier_id (ุงูููุฎุชุงุฑ)          โ
    โ  - action = 'confirm'               โ
    โ  - confidence = 100                 โ
    โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Step 2: GET AI SUGGESTIONS          โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
    โ Authority.getSuggestions()          โ
    โ  โ ุงูุงูุชุฑุงุญ ุงูุฃูู = topSuggestion   โ
    โโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Step 3: IMPLICIT REJECTION               โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
    โ IF topSuggestion.id != chosen_id:        โ
    โ   INSERT INTO learning_confirmations     โ
    โ    - raw_supplier_name                   โ
    โ    - supplier_id (ุงููุฑููุถ)               โ
    โ    - action = 'reject'                   โ
    โ    - confidence = topSuggestion.score    โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Result: Learning Signal Updated     โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
    โ ุงููุฑุฉ ุงูุชุงููุฉ โ LearningSignalFeederโ
    โ ุณููุนุทู ูุฒู ุฃุนูู ููุงุฎุชูุงุฑ ุงูุตุญูุญ    โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

#### ๐ Flow 6: ุงูุจุญุซ ูุงูุชููู

```
1๏ธโฃ ุงููุณุชุฎุฏู ูุฏุฎู ูููุฉ ุจุญุซ (search term)
    โ
2๏ธโฃ index.php ูุจูู SQL Query:
    WHERE (
      guarantee_number LIKE '%term%' OR
      raw_data LIKE '%"supplier":"%term%"%' OR
      raw_data LIKE '%"bank":"%term%"%' OR
      raw_data LIKE '%"contract_number":"%term%"%' OR
      suppliers.official_name LIKE '%term%'
    )
    โ
3๏ธโฃ NavigationService ููุญุณุจ:
    - totalRecords (ูู ูุทุงู ุงูุจุญุซ)
    - currentIndex (ูููุน ุงูุถูุงู ุงูุญุงูู)
    - prevId, nextId
    โ
4๏ธโฃ ุงูุนุฑุถ: ุฑูู X ูู Y ูู ูุชุงุฆุฌ ุงูุจุญุซ
    โ
5๏ธโฃ ุงูุชููู: ุงูุณุงุจู/ุงูุชุงูู ูุนูู ุถูู ูุชุงุฆุฌ ุงูุจุญุซ ููุท
```

---

### 4๏ธโฃ ุชุฏูู ุงูุจูุงูุงุช (Data Flow)

```
[Excel File]
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ INPUT: Excel Row                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ - Guarantee Number: "BG-12345/2026"     โ
โ - Supplier: "ุดุฑูุฉ ุงูููุฑุณ ุงููุญุฏูุฏุฉ"     โ
โ - Bank: "ุงูุฑุงุฌุญู ุงูุฑุฆูุณู"              โ
โ - Amount: "500,000.00"                  โ
โ - Issue Date: "01/01/2026"              โ
โ - Expiry Date: "31/12/2026"             โ
โ - Contract: "CT-2026-001"               โ
โ - Type: "Final Guarantee"               โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ NORMALIZATION (ุชุทุจูุน)                   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ BankNormalizer:                         โ
โ  "ุงูุฑุงุฌุญู ุงูุฑุฆูุณู" โ "ุงูุฑุงุฌุญู"         โ
โ                                         โ
โ ArabicNormalizer:                       โ
โ  "ุดุฑูุฉ ุงูููุฑุณ ุงููุญุฏูุฏุฉ" โ "ุดุฑูุฉุงูููุฑุณ" โ
โ                                         โ
โ Amount Parser:                          โ
โ  "500,000.00" โ 500000.00 (float)       โ
โ                                         โ
โ Date Parser:                            โ
โ  "01/01/2026" โ "2026-01-01"            โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STORAGE: guarantees Table               โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ id: 1234                                โ
โ guarantee_number: "BG-12345/2026"       โ
โ raw_data: {JSON} โ All fields as-is     โ
โ normalized_supplier_name: "ุดุฑูุฉุงูููุฑุณ"  โ
โ import_source: "excel_20260211_092145"  โ
โ imported_at: "2026-02-11 09:21:45"      โ
โ imported_by: "web_user"                 โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AI MATCHING (ูุทุงุจูุฉ ุชููุงุฆูุฉ)            โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ Input: "ุดุฑูุฉ ุงูููุฑุณ ุงููุญุฏูุฏุฉ"           โ
โ Normalized: "ุดุฑูุฉุงูููุฑุณ"                โ
โ                                         โ
โ 5 Signal Feeders:                       โ
โ  1. Alias โ Score: 95% (ID: 42)         โ
โ  2. Learning โ Score: 88% (ID: 42)      โ
โ  3. Fuzzy โ Score: 72% (ID: 42)         โ
โ  4. Anchor โ Score: 81% (ID: 42)        โ
โ  5. Historical โ Score: 91% (ID: 42)    โ
โ                                         โ
โ Aggregated: ID 42 โ 89% Confidence      โ
โ                                         โ
โ Suggestions:                            โ
โ  1. "ุดุฑูุฉ ุงูููุฑุณ ููููุงููุงุช" - 89%      โ
โ  2. "ุดุฑูุฉ ุงูููุฑุณ ุงูุชุฌุงุฑูุฉ" - 45%       โ
โ  3. "ุงูููุฑุณ ููุตูุงุนุฉ" - 31%             โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ USER DECISION (ูุฑุงุฑ ุงููุณุชุฎุฏู)           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ ุงูุงุฎุชูุงุฑ: #1 (ID: 42)                  โ
โ  โ ูุทุงุจู ุงูุงูุชุฑุงุญ ุงูุฃูู โ decision_source: 'ai_match'โ
โ                                         โ
โ Bank: Auto-matched to ID 7 ("ุงูุฑุงุฌุญู")  โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STORAGE: guarantee_decisions            โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ guarantee_id: 1234                      โ
โ supplier_id: 42                         โ
โ bank_id: 7                              โ
โ status: 'ready' โ Auto-evaluated        โ
โ decision_source: 'ai_match'             โ
โ confidence_score: 89.0                  โ
โ decided_at: "2026-02-11 09:23:15"       โ
โ decided_by: "web_user"                  โ
โ is_locked: 0                            โ
โ active_action: NULL                     โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ TIMELINE RECORDING (ุชุณุฌูู)             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ INSERT INTO guarantee_timeline:         โ
โ  - event_type: 'UE-01' (Decision)       โ
โ  - old_snapshot: {...}                  โ
โ  - new_data: {supplier_id: 42}          โ
โ  - description: "ูุฑุงุฑ ูุฏูู"             โ
โ  - created_by: "web_user"               โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ LEARNING FEEDBACK (ุชุนูู)                โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ INSERT INTO learning_confirmations:     โ
โ  1. action='confirm', supplier_id=42    โ
โ  2. action='reject', supplier_id=<other>โ
โ     (if top suggestion was different)   โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ACTION EXECUTION (ุชูููุฐ)                โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ User clicks "Release" โ                 โ
โ  LetterBuilder.prepare():               โ
โ   - Header: Bank details                โ
โ   - Subject: Release + BG# + Contract#  โ
โ   - Content: Release paragraph          โ
โ   - Signature: VP signature             โ
โ                                         โ
โ  UPDATE guarantee_decisions:            โ
โ   - is_locked = 1                       โ
โ   - locked_reason = 'released'          โ
โ   - status = 'released'                 โ
โ                                         โ
โ  INSERT INTO guarantee_timeline:        โ
โ   - event_type: 'AE-03' (Release)       โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ OUTPUT: Official Letter (HTML)          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ Ready for Print/PDF                     โ
โ Legally formatted                       โ
โ Contains all official data              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ููุงุญุธุฉ ูุงูุฉ:**

- `guarantees` ูุญุชูุธ ุจุงูุจูุงูุงุช ุงูุฎุงูุฉ (Immutable except for extend/reduce)
- `guarantee_decisions` ูุญุชูุธ ุจุงูุญุงูุฉ ุงูุญุงููุฉ (Mutable)
- `guarantee_timeline` ูุญุชูุธ ุจุงูุชุงุฑูุฎ ุงููุงูู (Append-only)

---

### 5๏ธโฃ ุงูุชุญููุงุช ูุงูุตูุงุญูุงุช (Validation & Authorization)

#### โ **ูุง ุชูุฌุฏ ููุธููุฉ ุตูุงุญูุงุช (Authorization System)**

**ุงูุญูููุฉ:**

- โ ูุง ููุฌุฏ ุฌุฏูู `users`
- โ ูุง ููุฌุฏ ูุธุงู Login/Logout
- โ ูุง ููุฌุฏ Role-Based Access Control (RBAC)
- โ ูุง ููุฌุฏ Session Management ูููุณุชุฎุฏููู
- โ ูุง ุชูุฌุฏ ุตูุงุญูุงุช (Permissions)

**ุงูููุท ุงูุญุงูู:**

- ุฌููุน ุงููุณุชุฎุฏููู ููู **ููุณ ุงูุตูุงุญูุงุช** (Full Access)
- ููุณุฌูู ุงุณู ุงููุณุชุฎุฏู ูู ุงูุฃุญุฏุงุซ ูู `decided_by` ุฃู `imported_by` ูููู **ูุตู ููุท** (ููุชุชุจุนุ ููุณ ููุตูุงุญูุงุช)

**ูุซุงู:**

```php
$decidedBy = Input::string($input, 'decided_by', 'web_user');
// โ ูุฐุง ูุฌุฑุฏ ูุต ููุณุฌูุ ูุง ููุชุญูู ููู
```

---

#### โ **ุงูุชุญููุงุช ุงูููุฌูุฏุฉ (Validation)**

##### 1. **Input Validation**

**ุงููููุน:** `app/Support/Input.php`

```php
Input::int($data, 'guarantee_id');    // ูุชุญูู ูู integer
Input::string($data, 'name', '');     // ูุชุญูู ูู string
```

**ุงูุชุญูู ูุญุฏูุฏ:** ููุท Type checkingุ ูุง ุชูุฌุฏ validation rules ูุนูุฏุฉ.

---

##### 2. **Business Rules Validation**

**ูู `save-and-next.php`:**

- supplier_id **ูุทููุจ**
- bank_id **ูุทููุจ**
- ID/Name Mismatch Check (ุฅุฐุง ุชุบูุฑ ุงูุงุณู โ ูููุบู ID)

**ูู `release.php`, `extend.php`, `reduce.php`:**

- ุงูุชุญูู ูู ุงูุญุงูุฉ: `status = 'ready'`
- ุงูุชุญูู ูู ุงูููู: `is_locked = 0`
- ุงูุชุญูู ูู ุงูุฅุฌุฑุงุก ุงูุณุงุจู: `active_action IS NULL`

**ูุซุงู:**

```php
if (empty($g['decision_id'])) {
    $blocked[] = [
        'guarantee_id' => $g['id'],
        'reason' => 'ูุง ููุฌุฏ ูุฑุงุฑ ููุฐุง ุงูุถูุงู'
    ];
    continue;
}

if (!empty($g['is_locked'])) {
    $blocked[] = [
        'guarantee_id' => $g['id'],
        'reason' => 'ูููู'
    ];
    continue;
}
```

---

##### 3. **Data Integrity**

**Foreign Keys:**

```sql
PRAGMA foreign_keys = ON;
```

ูุถูู ุนูุงูุงุช ุตุญูุญุฉ ุจูู ุงูุฌุฏุงูู.

**Type Safety ูู Repositories:**

```php
$supplierIdSafe = ($supplierId && $supplierId > 0) ? (int)$supplierId : null;
// โ ุชุญููู 0 ุฃู false ุฅูู NULL
```

---

##### 4. **Duplication Detection**

**ูู `ImportService`:**

```php
// ุงูุชุญูู ูู ุฑูู ุงูุถูุงู ุงูููุฑุฑ
$existing = $this->guaranteeRepo->findByNumber($guaranteeNumber);
if ($existing) {
    $duplicates++;
    $skipped[] = "ุงูุตู #{$rowNumber}: ุฑูู ุถูุงู ููุฑุฑ ({$guaranteeNumber})";
    continue;
}
```

---

### 6๏ธโฃ ุงูุนูุงุตุฑ ุงูุญุฑุฌุฉ vs ุงููุณุงุนุฏุฉ

#### ๐ด **ุงูุนูุงุตุฑ ุงูุญุฑุฌุฉ (Critical Components)**

ูุฐู ุงูุนูุงุตุฑ **ุฌููุฑูุฉ** ูุนูู ุงููุธุงูุ ูุดููุง = ูุดู ุงููุธุงู.

| ุงููููู | ุงูุณุจุจ | ุชุฃุซูุฑ ุงููุดู |
|--------|-------|-------------|
| **Database.php** | ููุจ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช | ุชููู ูุงูู |
| **GuaranteeRepository** | ุฌูุจ ูุญูุธ ุงูุถูุงูุงุช | ูุง ุจูุงูุงุช = ูุง ูุธุงู |
| **GuaranteeDecisionRepository** | ุฅุฏุงุฑุฉ ุงููุฑุงุฑุงุช ูุงูุญุงูุงุช | ูุง ูููู ุงุชุฎุงุฐ ูุฑุงุฑุงุช |
| **ImportService** | ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ูู Excel | ูุง ุฅุฏุฎุงู = ูุง ุนูู |
| **UnifiedLearningAuthority** | ุงููุทุงุจูุฉ ุงูุฐููุฉ | ูุชุญูู ุงููุธุงู ูู Manual ููุท |
| **save-and-next.php** | ุญูุธ ุงููุฑุงุฑุงุช | ูุง ูููู ุญูุธ ุงูุนูู |
| **LetterBuilder** | ุชูููุฏ ุงูุฎุทุงุจุงุช | ูุง ูุฎุฑุฌุงุช ุฑุณููุฉ |
| **release.php / extend.php / reduce.php** | ุชูููุฐ ุงูุฅุฌุฑุงุกุงุช | ูุง ูููู ุฅููุงุก ุงูุนูู |
| **TimelineRecorder** | ุงูุชุชุจุน ูุงูุชุฏููู | ููุฏุงู ุงูุชุงุฑูุฎ (ุฎุทูุฑ ูููุฑุงุฌุนุฉ ุงููุงููููุฉ) |
| **StatusEvaluator** | ุชุญุฏูุฏ ุญุงูุฉ ุงูุถูุงู | ููุทู ุงูุนูู ูููุงุฑ |

---

#### โช **ุงูุนูุงุตุฑ ุงููุณุงุนุฏุฉ (Auxiliary Components)**

ูุฐู ุงูุนูุงุตุฑ ุชุญุณูู ุงูุชุฌุฑุจุฉ ููููุง **ููุณุช ุถุฑูุฑูุฉ** ูููุธููุฉ ุงูุฃุณุงุณูุฉ.

| ุงููููู | ุงููุธููุฉ | ุชุฃุซูุฑ ุงููุดู |
|--------|---------|-------------|
| **Smart Paste** | ูุตู ุจูุงูุงุช ููุณูุฎุฉ | ูููู ุงูุงุณุชูุฑุงุฏ ุนุจุฑ Excel |
| **Batch Operations** | ูุนุงูุฌุฉ ุฌูุงุนูุฉ | ูููู ุงููุนุงูุฌุฉ ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ |
| **ConflictDetector** | ูุดู ุงูุชูุงูุถุงุช | ุชุญุฐูุฑุงุช ููุท (ูุง ูููุน ุงูุนูู) |
| **Statistics Page** | ุงูุฅุญุตุงุฆูุงุช | ูุนูููุงุช ููุท (ูุง ุชุคุซุฑ ุนูู ุงูุนูู) |
| **NavigationService** | ุงูุชููู ุงูุฐูู | ูููู ุงูุชููู ุงููุฏูู |
| **NoteRepository** | ุงูููุงุญุธุงุช | ููุฒุฉ ุฅุถุงููุฉ |
| **AttachmentRepository** | ุงููุฑููุงุช | ููุฒุฉ ุฅุถุงููุฉ |
| **Maintenance Page** | ุฃุฏูุงุช ุงูุตูุงูุฉ | ูุฃุบุฑุงุถ ุงูุชูุธูู |
| **Test Data Isolation** | ูุตู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ | ููุงุฎุชุจุงุฑ ููุท |
| **Logger** | ุชุณุฌูู ุงูุฃุฎุทุงุก | ููุชุดุฎูุต (ููุณ ูููุธููุฉ) |

---

### 7๏ธโฃ ุฃูู ุชุญุฏุซ ุงูููุทููุฉ ุงูุชุฌุงุฑูุฉ ูุงูุชุญููุ

#### **Business Logic Locations**

| ุงูููุทููุฉ | ุงููููุน | ุงููุตู |
|---------|--------|-------|
| **Supplier Matching** | `UnifiedLearningAuthority` + 5 Feeders | ููุทู AI ุงูุฑุฆูุณู |
| **Status Evaluation** | `StatusEvaluator.php` | pending vs ready |
| **Active Action Logic** | `save-and-next.php` (lines 296-314) | ADR-007 |
| **Lock Logic** | `release.php`, `extend.php`, `reduce.php` | ููุน ุงูุชุนุฏูู ุจุนุฏ ุงูุฅุฌุฑุงุก |
| **Learning Feedback** | `save-and-next.php` (lines 340-386) | Confirm + Reject |
| **Duplicate Detection** | `ImportService.php` | ููุน ุงูุงุณุชูุฑุงุฏ ุงูููุฑุฑ |
| **Auto-Create Supplier** | `save-and-next.php` (lines 80-122) | ุฅูุดุงุก ุชููุงุฆู ููููุฑุฏูู |
| **Bank Auto-Match** | `ImportService.php` + `BankNormalizer` | ูุทุงุจูุฉ ุงูุจูู ูุฑุฉ ูุงุญุฏุฉ |
| **Letter Content Selection** | `LetterBuilder.php` (buildContent) | ุงุฎุชูุงุฑ ุงููุญุชูู ุญุณุจ ุงูููุน |

---

#### **Validation Locations**

| ุงูุชุญูู | ุงููููุน | ุงููุตู |
|--------|--------|-------|
| **Required Fields** | `save-and-next.php` (lines 135-148) | guarantee_id, supplier_id |
| **Bank Requirement** | `save-and-next.php` (lines 178-188) | bank_id ูุทููุจ |
| **Ready State** | `release.php`, `extend.php`, `reduce.php` | ุงูุชุญูู ูู ุงูุญุงูุฉ |
| **Lock State** | ุฌููุน APIs ุงูุชูููุฐูุฉ | ูุง ูููู ุงูุชุนุฏูู ุฅุฐุง ูููู |
| **Active Action** | `extend.php`, `reduce.php` | ูุง ุฅุฌุฑุงุก ุฌุฏูุฏ ุฅุฐุง ููุฌุฏ ุณุงุจู |
| **Date Validation** | `BatchService.php` (isValidDate) | ุตูุบุฉ ุงูุชุงุฑูุฎ |
| **Batch Status** | `BatchService.php` (isBatchClosed) | ูุง ูุนุงูุฌุฉ ููุฏูุนุงุช ุงููุบููุฉ |
| **Type Safety** | `GuaranteeDecisionRepository.php` | ุชุญููู 0 โ NULL |

---

## ๐ ุงูุฎูุงุตุฉ: ุงูููู ุงูุชุดุบููู ุงููุงูู

### โ ูุง ููููุงู ุจูุถูุญ

1. **ุงููุดููุฉ**: ุฅุฏุงุฑุฉ ุถูุงูุงุช ุจูููุฉ ุจูุทุงุจูุฉ ุฐููุฉ ูุชูููุฏ ุฎุทุงุจุงุช ุฑุณููุฉ
2. **ุงูุญู**: ูุธุงู AI-powered ูุณุชูุฑุฏุ ูุทุงุจูุ ูุชุนููุ ููููุฏ ูุฎุฑุฌุงุช ูุงููููุฉ
3. **ุงูุชุฏููุงุช**: 6 ุชุฏููุงุช ุฑุฆูุณูุฉ ูุญุฏุฏุฉ ุจูุถูุญ
4. **ุงููุญุฏุงุช**: 6 ูุญุฏุงุช ุฃุณุงุณูุฉ (Import, Matching, Decision, Timeline, Action, Letters)
5. **ุงูุจูุงูุงุช**: 3 ุทุจูุงุช (guarantees = raw, guarantee_decisions = state, guarantee_timeline = history)
6. **ุงูุชุญููุงุช**: ุนูู ูุณุชูู Business Rules (ูุง ููุธููุฉ ุตูุงุญูุงุช)
7. **ุงูุญุฑุฌ**: 10 ููููุงุช ุญุฑุฌุฉ vs 9 ูุณุงุนุฏุฉ

### โ๏ธ ููุงุท ุถุนู ูุญุชููุฉ (ุณูุชู ุงูุชุญูู ูู PHASE 2)

1. **ูุง ุตูุงุญูุงุช**: ุฃู ูุณุชุฎุฏู ููููู ูุนู ุฃู ุดูุก
2. **ูุง Migrations**: ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชููุดุฃ ุฏููุงููููุงู (ุบูุฑ ููุซูุฉ)
3. **ูููุงุช ูุจูุฑุฉ**: index.php = 1059 ุณุทุฑ (God File)
4. **Exception Handling**: ุบูุฑ ููุญุฏ (try-catch ูุชูุงุซ ุฑ)
5. **Logging**: ููุฌูุฏ ููู ุงุณุชุฎุฏุงูู ุบูุฑ ูุงุถุญ

---

**โ PHASE 1 ููุชููุฉ - ุฌุงูุฒ ููุงูุชูุงู ุฅูู PHASE 2: Deep Static Code Audit**
