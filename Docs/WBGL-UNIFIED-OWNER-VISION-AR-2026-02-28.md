# الرؤية التنفيذية الموحدة لمالك نظام WBGL (دمج 3 رؤى)

تاريخ الإصدار: 2026-02-28  
الحالة: **Proposed for Adoption**  
نمط التنفيذ: **تتابعي قائم على إغلاق المراحل (Gate-Based)** بدون تقويم إلزامي

المراجع المعتمدة:
- `Docs/critical-feature-discovery-report.md`
- `Docs/forWBGL_master_plan.md`
- `Docs/forWBGL.md`
- `Docs/INDEX-DOCS-AR.md`
- `Docs/WBGL_COGNITIVE_AUDIT_CLAIM_VALIDATION_AR.md`
- `Docs/wbgl-cognitive-system-audit-ar.md`
- `Docs/wbgl-docs-consistency-summary-needs-audit-ar-2026-02-28.md`
- `Docs/WBGL-UNIFIED-RESOLVED-REPORT-AR-2026-02-28.md`
- `Docs/WBGL-FINAL-CLAIMS-REGISTER-AR-2026-02-28.md`
- `Docs/WBGL-ROADMAP-INSTRUCTIONS-AR-2026-02-28.md`
- `Docs/wbgl-feedback-meeting-baseline-ar-2026-02-28.md`
- `Docs/wbgl-human-risk-report-ar-2026-02-28.md`
- `Docs/wbgl-role-operational-analysis-ar-2026-02-28.md`
- `Docs/wbgl-ui-first-operational-identity-audit-ar-2026-02-28.md`

---

## 1) موقف المالك (Executive Position)

- النظام ليس كارثة، لكنه **عالي الخطورة على موثوقية القرار** إذا استمرت الثغرات الصامتة.
- البنية الحوكمية قوية فعليًا، والمشكلة الأساسية في **اتساق التنفيذ ووضوح التجربة**.
- القرار الإداري الحاكم: **لا ميزات جديدة قبل تثبيت الاستقرار**.
- السؤال التنفيذي المرجعي:  
  **"هل أستطيع الوثوق بهذا النظام لاتخاذ قرار مالي عالي الأثر غدًا؟"**  
  الإجابة الحالية: **ليس بعد**.  
  الإجابة المستهدفة عند إغلاق دورة الاستقرار: **نعم، بشروط قياس واضحة**.

---

## 2) القرارات الفورية (بداية التنفيذ)

1. تجميد التطوير الوظيفي الجديد حتى إغلاق `P0` (Feature Freeze).
2. تفعيل War Room تقني بأولوية واحدة: "منع أي سلوك يهدد الثقة أو يسبب كتابة غير مقصودة".
3. تحويل المخاطر إلى Backlog تنفيذي موحد (`P0/P1/P2`) مرتبط بـ `FR-*` وبنود تحقق.
4. منع الإيقاف المفاجئ للمسارات: أي تعطيل يتم عبر `feature flag` + `rollback` جاهز.

---

## 3) خطة التنفيذ الموحدة (تتابعيًا)

## المرحلة 0: تهيئة الاستقرار

1. اعتماد خط أساس للمؤشرات (الزمن، الفشل، رفض الصلاحيات، تذاكر الدعم).
2. تعيين مالك تنفيذي لكل بند `P0`.
3. اعتماد Definition of Done موحد تقنيًا وتشغيليًا.
4. تجهيز Regression Pack إلزامي قبل أي نشر.
5. اعتماد مصفوفة تتبع إلزامية تغطي: `FR-01..FR-25` + `R01..R16` + `G01..G30` + `C01..C25`.
6. تطبيق قواعد التنفيذ من `forWBGL.md`: أولوية `T1` أولاً، حد عمل متوازي `WIP<=3`، وعدم بدء `T3` قبل إغلاق 80% من `T1`.

المخرجات:
1. لوحة تنفيذ واحدة مرتبطة بالـ claims.
2. تقرير مخاطر أسبوعي.
3. سياسة نشر: Canary + Rollback.
4. تقرير تتبع تغطية (Coverage Report) لا يقل عن 100% للعناصر الإلزامية.

## المرحلة 1: إطفاء الحرائق وإغلاق P0

### P0-1: فصل القراءة عن الكتابة (`FR-03`)
- المشكلة: `get-record` قد يسبب write صامت.
- التنفيذ:
1. جعل `get-record` قراءة صافية 100%.
2. نقل `auto-matching` إلى endpoint/إجراء صريح منفصل.
3. إضافة `read_only=true` كضمان تعاقدي في الطلبات التي هدفها العرض فقط.
- معيار الإغلاق:
1. اختبارات تثبت عدم وجود write عند القراءة.
2. عداد `read-triggered writes` يساوي صفر.

### P0-2: إصلاح بوابات الصلاحيات في `reopen/break-glass` (`FR-06`)
- المشكلة: تعارض بين RBAC والتنفيذ الفعلي.
- التنفيذ:
1. التحقق من `reopen_*` و`break_glass_override` قبل أي بوابة غير لازمة.
2. الإبقاء على فحص `object-level visibility` إلزاميًا قبل التنفيذ.
3. توحيد الشرط بين reopen المفرد والدفعات.
- معيار الإغلاق:
1. نجاح reopen للأدوار المخولة > 95%.
2. اختفاء حالات "عندي صلاحية لكن endpoint يرفض" في المسارات الحرجة.

### P0-3: ضبط صلاحيات الكتابة الحساسة (`FR-22`)
- المشكلة: `save-and-next` أقل صرامة من مسارات mutate الأخرى.
- التنفيذ:
1. توحيد gate الصلاحيات مع بقية write endpoints.
2. منع أي تعديل غير مقصود من أدوار لا تملك mutate فعليًا.
- معيار الإغلاق:
1. Contract tests تثبت اتساق الإنفاذ عبر endpoints المتشابهة.

### P0-4: إغلاق الانجراف بين الكود وقاعدة البيانات (`FR-25`)
- المشكلة: drift حقول/جداول يسبب سلوكًا غير متوقع.
- التنفيذ:
1. مسح شامل لمسارات الكتابة وتوحيد العقود على schema الفعلي.
2. إصلاحات migration للفهارس/القيود اللازمة.
3. تفعيل schema contract checks داخل CI.
- معيار الإغلاق:
1. لا كتابة لحقول غير موجودة.
2. فشل CI فوري عند أي drift جديد.

### P0-5: مسارات عالية المخاطر المكتشفة بالتقارير
- `api/convert-to-real.php`: تعطيل مؤقت عبر feature flag، ثم إعادة كتابة أو إزالة نهائية.
- `api/commit-batch-draft.php`: إيقاف مؤقت حتى إزالة الاعتماد على `status_flags` أو مواءمته schema.
- `api/create-guarantee.php`: توحيد `import_source` و`batch_type` عبر طبقة توافق انتقالية ثم حسم نهائي.
- معيار الإغلاق:
1. لا endpoint مكسور متاح للمستخدم النهائي.
2. خطة deprecation موثقة لأي مسار مزدوج.

### P0-6: حماية الضوابط القائمة من التراجع (Governance/Security Non-Regression)
- التنفيذ:
1. تثبيت اختبارات تمنع كسر `CSRF/session hardening/security headers`.
2. تثبيت اختبارات تمنع كسر `undo separation-of-duties` و`break-glass audit`.
3. تثبيت اختبارات سلامة `timeline/print/settings audit/dead-letter` كقدرات لا يجوز فقدها أثناء الإصلاح.
- معيار الإغلاق:
1. كل اختبارات non-regression للضوابط الحرجة تعمل في CI قبل أي نشر.

## المرحلة 2: الثقة والوضوح التشغيلي

1. توحيد عقود API إلى قالب موحد: `{success, data, error, request_id}`.
2. توحيد رسائل الرفض: "لماذا رُفض؟ ما الصلاحية المطلوبة؟ من الجهة المخولة؟ ما الخطوة التالية؟".
3. تعميق `UiPolicy`: إخفاء الأزرار غير المصرح بها بدل الرفض بعد الضغط.
4. إضافة شريط حالة واضح: `status` مقابل `workflow_step` مقابل `active_action`.
5. توحيد دورة `Undo` مقابل `Reopen` بقصة تشغيلية مفهومة.
6. توحيد معالجة التكرارات عبر كل قنوات الإدخال (بما فيها Smart Paste).
7. تفعيل enforcement مركزي للصلاحيات عبر `Policy Matrix` في `api/_bootstrap.php` مع `deny-by-default` وتدقيق `denied-access`.
8. توحيد إنفاذ `released read-only` على كل مسارات الكتابة مع اختبارات non-regression.
9. فرض `object-level visibility` على كل direct-id endpoints قراءة/كتابة دون استثناء.
10. توحيد دلالة ذرية الدفعات (`per-record transaction`) في API/UI ورسائل المستخدم مع قرار صريح حول عدم دعم all-or-none حاليًا.
11. تنفيذ `assigned_to` و`only_my_tasks` كطابور عمل تشغيلي رسمي للأدوار.
12. توفير إدارة `Profile/Password` ذاتية واضحة للمستخدم النهائي.
13. توسيع `Metrics/Alerts` لتصبح لوحة تشغيل role-scoped بدل حصرها على شاشة صيانة محدودة.
14. حسم سياسة العلاقة بين `workflow_step` وعمليات `extend/reduce/release` ثم توحيد إنفاذها عبر كل المسارات.
15. تصحيح عقد `get-current-state` ليعيد `active_action` بما يتوافق مع توقعات الواجهة.
16. إطلاق تدريب role-based قصير ومباشر مع سيناريوهات ضغط واقعية لكل دور.

المخرجات:
1. انخفاض تذاكر الدعم المتعلقة بالصلاحيات.
2. انخفاض الارتباك التشغيلي في UAT role-based.
3. اتساق أعلى في تجربة الواجهة والرسائل.

## المرحلة 3: تخفيض الدين التقني ورفع الإنتاجية

1. دمج المسارات المكررة:
- توحيد `create-guarantee` و`manual-entry` خلف خدمة واحدة.
- حسم `parse-paste.php` مقابل `parse-paste-v2.php` (دمج أو حذف بعد deprecation قصيرة).
2. إعادة هيكلة الصلاحيات:
- فصل `manage_data` إلى `operate_daily` و`govern_undo`.
- ضمان عدم self-approval في مسارات الحوكمة الحساسة.
3. تحسين الأداء:
- Pagination حقيقي للدفعات/الـ timeline.
- Lazy loading للبيانات الثقيلة.
4. تحديث الوثائق:
- `README` يعكس البيئة الفعلية (PostgreSQL).
- أدلة تشغيل مختصرة حسب الدور.
5. إعادة هيكلة معمارية تدريجية (Module Boundaries + Dependency Rules) لتحقيق `R01/R02/R04/R05`.
6. تحديث نموذج البيانات إلى Core Typed Model مع `raw_data` كطبقة توافق انتقالية (`dual-write -> cutover`) لتحقيق `R06`.
7. اعتماد طبقة تحقق مدخلات موحدة لكل endpoints الكتابية (`G25`) بدل منطق تحقق متفرق.
8. توحيد سلوك `notes/attachments/notifications/preferences` تعاقديًا وتدقيقيًا لمنع drift بين القنوات.

المخرجات:
1. تحسين throughput تحت الضغط.
2. تخفيض الحمل الذهني في المسارات اليومية.
3. تقليل الانحراف بين الوثائق والتنفيذ الفعلي.

---

## 4) المرحلة الممتدة بعد إغلاق المرحلة 3

1. تفعيل Dashboard تشغيلي لحظي للأدوار الإشرافية والإدارية.
2. دورة تقييم مخاطر بشرية دورية بقياس مرحلي معتمد.
3. حوكمة تغيير صارمة: أي endpoint/schema جديد يمر بمراجعة تعاقدية إلزامية.

---

## 5) ما لن نفعله

1. لن نعيد كتابة النظام من الصفر.
2. لن نطلق ميزات كبيرة قبل إغلاق `P0`.
3. لن نقبل "نصلح لاحقًا" في مخاطر الثقة الأساسية.
4. لن نُبقي مسارات مزدوجة بلا قرار حاسم وdeprecation.

---

## 6) مؤشرات النجاح الرسمية (KPIs)

1. `read-triggered writes` = 0.
2. انخفاض `Permission Denied after click` بنسبة >= 60%.
3. نجاح `reopen` للأدوار المخولة > 95%.
4. فشل `Manual Entry` < 1%.
5. انخفاض تذاكر دعم الصلاحيات >= 50%.
6. تحسن زمن معالجة الدفعات >= 25%.
7. تغطية تتبعية كاملة `FR/R/G/C` بنسبة 100% مع دليل إغلاق لكل بند.
8. التزام endpoints الكتابية بطبقة Validator موحدة = 100%.
9. التزام API envelope الموحد >= 95% مع `request_id` في كل الاستجابات القياسية.
10. تفعيل `assigned_to` و`only_my_tasks` على الرحلات الأساسية بنسبة استخدام تشغيلي >= 85%.

---

## 7) حوكمة التنفيذ والمتابعة

1. اجتماع تنفيذي أسبوعي (45 دقيقة): قرار/تصعيد/إزالة عوائق.
2. اجتماع تشغيلي أسبوعي (30 دقيقة): تحقق من أثر الإصلاح على الأدوار.
3. تقرير أسبوعي إلزامي: `Done / Blocked / Risk / Next`.
4. أي تعثر `P0` مستمر يُصعّد مباشرة لمالك النظام.
5. `Monthly Traceability Gate`: لا انتقال مرحلة قبل تأكيد تغطية البنود الإلزامية بدون فجوات.
6. أي بند يحقق الهدف ويكسر Guardrail يعود فورًا إلى `Open` (قاعدة منع تآكل الحوكمة).
7. أي تغيير إنتاجي يجب أن يمر عبر `change record` مكتمل وقابل للتدقيق قبل النشر.

قالب تتبع البنود:

| ID | البند | الأولوية | المالك | الترتيب | الحالة | معيار الإغلاق |
|---|---|---|---|---|---|---|
| FR-03 | فصل read/write | P0 | Tech Lead | المرحلة 1 | Open | Zero read-triggered writes |
| FR-06 | إصلاح reopen gates | P0 | Backend Lead | المرحلة 1 | Open | >95% reopen success |
| FR-22 | توحيد gate save-and-next | P0 | API Owner | المرحلة 1 | Open | Gate parity tests pass |
| FR-25 | إغلاق schema drift | P0 | DB Lead | المرحلة 1 | Open | CI schema checks enforced |

---

## 8) قرار نهاية دورة الاستقرار

1. إذا أُغلقت `P0` وتحسنت المؤشرات: الانتقال إلى Roadmap النمو.
2. إذا بقيت ثغرات ثقة/صلاحيات: تمديد stabilization دورة إضافية.
3. لا عودة لميزات جديدة قبل ثبات السلوك والصلاحيات على القياسات الرسمية.

---

## 9) مصفوفة التتبع الإلزامية

- المرجع الإجباري للتغطية الكاملة موجود في:
  `Docs/WBGL-FULL-TRACEABILITY-MATRIX-AR.md`
- لا يعتبر البرنامج مغلقًا قبل اعتماد المصفوفة بحالة:
  `All Mandatory Items = Covered / Covered-with-Action` بدون `Open Gap`.
